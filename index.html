<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€AIæ©Ÿèƒ½æ­è¼‰ã€‘ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Webåºƒå‘Šäºˆç®—ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #F8F9FA; }
        .tab-active { border-bottom-color: #0d9488; color: #0d9488; font-weight: 600; }
        .tab-inactive { border-bottom-color: transparent; color: #6b7280; }
        .nav-active { background-color: #14b8a6; color: white; }
        .nav-inactive { background-color: white; color: #374151; }
        .sim-mode-btn-active { background-color: #0d9488; color: white; }
        .sim-mode-btn-inactive { background-color: #f3f4f6; color: #374151; }
        .optional-input-btn-active { background-color: #14b8a6; color: white; }
        .optional-input-btn-inactive { background-color: #e5e7eb; color: #4b5563; }
        .case-study-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .case-study-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 320px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0d9488; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .knowledge-card .formula { @apply bg-teal-50 border border-teal-200 text-teal-800 p-3 rounded-lg text-center text-base font-bold font-mono shadow-sm whitespace-nowrap overflow-x-auto; }
        .input-group, .optional-group { transition: opacity 0.3s ease-in-out; }
        .info-icon { cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .info-icon:hover { color: #1f2937; }
        #tooltip { position: absolute; background-color: #1f2937; color: white; padding: 12px; border-radius: 8px; width: 280px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        #tooltip.visible { opacity: 1; visibility: visible; }
        #tooltip h4 { font-weight: bold; font-size: 1rem; margin-bottom: 8px; }
        #tooltip p { font-size: 0.875rem; line-height: 1.5; }
        #tooltip .formula { background-color: #374151; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; margin-top: 8px; word-break: break-all; }
        .custom-input { border: none; border-bottom: 1px solid #d1d5db; border-radius: 0; padding-left: 0; padding-right: 2.5rem; background-color: transparent; }
        .custom-input:focus { --tw-ring-shadow: none !important; box-shadow: none !important; border-bottom-color: #0d9488; outline: none; }
        .input-wrapper { position: relative; }
        .input-unit { position: absolute; right: 0; bottom: 8px; color: #6b7280; pointer-events: none; }
        .result-value { font-size: 1.5rem; font-weight: bold; word-break: break-all; line-height: 1.2; }
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f9fafb;
        }
        .auth-card {
            max-width: 420px;
            width: 100%;
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- ===== ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ã‚³ãƒ³ãƒ†ãƒŠ ===== -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto px-4 py-8">
            <header class="text-center mb-8 flex justify-between items-center">
                <div></div>
                <div>
                    <h1 class="text-4xl font-bold text-teal-700">ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Webåºƒå‘Šäºˆç®—ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
                    <p class="mt-2 text-lg text-gray-600">éå»ãƒ‡ãƒ¼ã‚¿ãŒãªã„çŠ¶æ…‹ã‹ã‚‰ã€è«–ç†çš„ãªåºƒå‘Šäºˆç®—ã¨æˆ¦ç•¥ã‚’ç­–å®šã™ã‚‹</p>
                </div>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </header>
            
            <nav class="bg-white rounded-lg shadow-md p-2 flex flex-wrap justify-center gap-2 mb-8">
                <button data-section="simulator" class="nav-btn nav-active flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</button>
                <button data-section="case-studies" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£</button>
                <button data-section="knowledge" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">ç”¨èªãƒ»è¨ˆç®—å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</button>
                <button data-section="benchmarks" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</button>
                <button data-section="optimization" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰</button>
            </nav>

            <main>
                <section id="simulator" class="content-section">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
                            <p class="text-gray-500 mt-1">çŠ¶æ³ã«åˆã‚ã›ã¦è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€åºƒå‘Šäºˆç®—ã‚„æˆæœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚</p>
                        </div>
                        <div class="mb-8 p-1 bg-gray-100 rounded-lg flex flex-col sm:flex-row gap-1 max-w-4xl mx-auto">
                            <button data-mode="A" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">A: ç›®æ¨™åˆ©ç›Šã‹ã‚‰ç®—å‡º</button>
                            <button data-mode="B" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">B: ç›®æ¨™å£²ä¸Šã‹ã‚‰ç®—å‡º</button>
                            <button data-mode="C" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">C: äºˆç®—ã‹ã‚‰æˆæœã‚’äºˆæ¸¬</button>
                            <button data-mode="D" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">D: KPIç›®æ¨™ã‹ã‚‰é€†ç®—</button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                            <div class="lg:col-span-3 space-y-8">
                                <div class="space-y-6">
                                    <div id="mode-A-inputs" class="input-group space-y-6">
                                        <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰A: å¿…é ˆé …ç›®</h3>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™åˆ©ç›Š (æœˆ)</label><input type="number" id="a-targetProfit" class="simulator-input custom-input mt-1 block w-full" placeholder="500000"><span class="input-unit">å††</span></div>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡ (LTV)</label><input type="number" id="a-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                        <div>
                                            <label for="a-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                            <select id="a-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                                <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                                <option value="margin">åŸä¾¡ç‡ (%)</option>
                                            </select>
                                        </div>
                                        <div id="a-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="a-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                        <div id="a-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="a-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™CPAã®ç®—å‡ºæ–¹æ³•ã‚’é¸æŠ</label>
                                            <div class="flex gap-2">
                                                <button id="a-profit-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">åˆ©ç›Šé¡ã§æŒ‡å®š</button>
                                                <button id="a-roas-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™ROASã§æŒ‡å®š</button>
                                                <button id="a-roi-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™ROIã§æŒ‡å®š</button>
                                            </div>
                                        </div>
                                        <div id="a-profit-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç¢ºä¿ã—ãŸã„åˆ©ç›Š/CV</label><input type="number" id="a-profitPerCv" class="simulator-input custom-input mt-1 block w-full" placeholder="2000"><span class="input-unit">å††</span></div>
                                        <div id="a-roas-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™ROAS (%)</label><input type="number" id="a-targetRoas" class="simulator-input custom-input mt-1 block w-full" placeholder="500"><span class="input-unit">%</span></div>
                                        <div id="a-roi-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™ROI (%)</label><input type="number" id="a-targetRoi" class="simulator-input custom-input mt-1 block w-full" placeholder="100"><span class="input-unit">%</span></div>
                                    </div>
                                   <div id="mode-B-inputs" class="input-group hidden space-y-6">
                                        <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰B: å¿…é ˆé …ç›®</h3>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™å£²ä¸Š (æœˆ)</label><input type="number" id="b-targetSales" class="simulator-input custom-input mt-1 block w-full" placeholder="3000000"><span class="input-unit">å††</span></div>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡</label><input type="number" id="b-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                        <div>
                                             <label for="b-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                            <select id="b-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                                <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                                <option value="margin">åŸä¾¡ç‡ (%)</option>
                                            </select>
                                        </div>
                                        <div id="b-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="b-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                        <div id="b-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="b-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                    </div>
                                    <div id="mode-C-inputs" class="input-group hidden space-y-6">
                                        <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰C: å¿…é ˆé …ç›®</h3>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">æŠ•ä¸‹å¯èƒ½äºˆç®— (æœˆ)</label><input type="number" id="c-availableBudget" class="simulator-input custom-input mt-1 block w-full" placeholder="1000000"><span class="input-unit">å††</span></div>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡</label><input type="number" id="c-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                        <div>
                                            <label for="c-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                            <select id="c-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                                <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                                <option value="margin">åŸä¾¡ç‡ (%)</option>
                                            </select>
                                        </div>
                                        <div id="c-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="c-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                        <div id="c-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="c-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                    </div>
                                     <div id="mode-D-inputs" class="input-group hidden space-y-6">
                                        <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰D: å¿…é ˆé …ç›®</h3>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·ç‚¹ã‚’é¸æŠ</label>
                                            <div class="flex gap-2">
                                                <button id="d-cv-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™CVæ•°ã‹ã‚‰ç®—å‡º</button>
                                                <button id="d-cpa-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™CPAã‹ã‚‰ç®—å‡º</button>
                                            </div>
                                        </div>
                                        <div id="d-cv-wrapper" class="input-wrapper">
                                            <label class="block text-sm font-medium text-gray-700">ç›®æ¨™CVæ•°</label><input type="number" id="d-targetCv" class="simulator-input custom-input mt-1 block w-full" placeholder="100"><span class="input-unit">ä»¶</span>
                                        </div>
                                        <div id="d-cpa-wrapper" class="hidden space-y-6">
                                              <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™CPA</label><input type="number" id="d-targetCpa" class="simulator-input custom-input mt-1 block w-full" placeholder="15000"><span class="input-unit">å††</span></div>
                                              <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™åˆ©ç›Š</label><input type="number" id="d-targetProfit" class="simulator-input custom-input mt-1 block w-full" placeholder="500000"><span class="input-unit">å††</span></div>
                                        </div>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡ (LTV)</label><input type="number" id="d-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                        <div>
                                            <label for="d-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                            <select id="d-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                                <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                                <option value="margin">åŸä¾¡ç‡ (%)</option>
                                            </select>
                                        </div>
                                        <div id="d-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="d-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                        <div id="d-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="d-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                    </div>
                                    <div class="pt-6 border-t">
                                        <h3 class="text-lg font-semibold text-gray-700 mb-4">å…±é€šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬</h3>
                                        <div class="space-y-6">
                                            <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">æ¨å®šCVR (%)</label><input type="number" id="common-cvr" class="simulator-input custom-input mt-1 block w-full" placeholder="1.0" step="0.1"><span class="input-unit">%</span></div>
                                            <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">æ¨å®šCPC (å††)</label><input type="number" id="common-cpc" class="simulator-input custom-input mt-1 block w-full" placeholder="200"><span class="input-unit">å††</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="bg-teal-50/50 p-6 rounded-lg space-y-4 sticky top-8">
                                    <h3 id="results-title" class="text-lg font-semibold text-center text-teal-800">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h3>
                                    <div id="results-main" class="grid grid-cols-2 gap-4"></div>
                                    <div id="results-scenario" class="pt-4"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-12">
                           <div class="chart-container">
                               <canvas id="budgetChart"></canvas>
                           </div>
                        </div>
                        <div id="ai-section" class="mt-12 pt-8 border-t-2 border-teal-100">
                             <div class="text-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">ğŸ¤– AIã«ã‚ˆã‚‹ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¢ã‚·ã‚¹ãƒˆ</h2>
                                <p class="text-gray-500 mt-1">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’åŸºã«ã€å…·ä½“çš„ãªåºƒå‘Šæˆ¦ç•¥ã‚’AIãŒææ¡ˆã—ã¾ã™ã€‚</p>
                            </div>
                            <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow">
                                <div>
                                    <label for="productDescription" class="block text-sm font-medium text-gray-700">å®£ä¼ã—ãŸã„å•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…·ä½“çš„ã«å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                                    <textarea id="productDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="ä¾‹: æ±äº¬ãƒ»æ¸‹è°·ã«ã‚ã‚‹ã€åˆå¿ƒè€…å‘ã‘ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¸ãƒ ã€‚å®Œå…¨å€‹å®¤ã§ã€ä¸€äººã²ã¨ã‚Šã«åˆã‚ã›ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³ã‚’æä¾›ã€‚"></textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="adUrl" class="block text-sm font-medium text-gray-700">åºƒå‘Šã§ä½¿ç”¨ã™ã‚‹URL <span class="text-xs text-gray-500">(ä»»æ„)</span></label>
                                    <input type="url" id="adUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="https://example.com/product-page">
                                    <p class="mt-1 text-xs text-gray-500">URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’è€ƒæ…®ã—ãŸææ¡ˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                                </div>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <button id="generateTargetingBtn" class="sm:col-span-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆã‚’ç”Ÿæˆ ğŸ¯</button>
                                    <button id="generateCopyBtn" class="sm:col-span-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆ âœ¨</button>
                                    <button id="generateKeywordsBtn" class="sm:col-span-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ ğŸ’¡</button>
                                </div>
                            </div>
                            <div id="aiResultContainer" class="mt-6 max-w-4xl mx-auto"></div>
                        </div>
                    </div>
                </section>
                <section id="case-studies" class="content-section hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£</h2><p class="text-gray-500 mt-1">äº‹ä¾‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚</p></div><div id="caseStudiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div></section>
                <section id="knowledge" class="content-section hidden">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-800">ç”¨èªãƒ»è¨ˆç®—å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</h2>
                            <p class="text-gray-500 mt-2">åºƒå‘Šäºˆç®—ã®ç­–å®šã«å¿…è¦ãªä¸»è¦ãªæŒ‡æ¨™ã¨è¨ˆç®—å¼ã®ä¸€è¦§ã§ã™ã€‚</p>
                        </div>
                        <div id="knowledge-container" class="space-y-8 max-w-6xl mx-auto">
                        </div>
                    </div>
                </section>
                <section id="benchmarks" class="content-section hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h2><p class="text-gray-500 mt-1">å„ç¨®åºƒå‘Šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ¥­ç•Œåˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã§ã™ã€‚â€»å„èª¿æŸ»ä¼šç¤¾ã®å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã—ãŸå‚è€ƒå€¤ã§ã™ã€‚</p></div><div><div class="border-b border-gray-200"><nav id="benchmarkTabs" class="-mb-px flex flex-wrap space-x-6" aria-label="Tabs"></nav></div><div id="benchmarkContent" class="mt-6"></div></div></div></section>
                <section id="optimization" class="content-section hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰</h2><p class="text-gray-500 mt-1">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹å¾Œã«ã‚ˆãã‚ã‚‹å•é¡Œã¨ãã®å¯¾å‡¦æ³•ã€‚</p></div><div class="max-w-3xl mx-auto space-y-4" id="accordionContainer"></div></div></section>
            </main>
        </div>
    </div>

    <!-- ===== èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ ===== -->
    <div id="auth-container" class="hidden">

        <!-- 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="loading-section" class="auth-container">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</p>
            </div>
        </div>

        <!-- 2. ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ç”»é¢ -->
        <div id="login-section" class="auth-container hidden">
            <div class="auth-card text-center">
                <h2 id="auth-title" class="text-2xl font-bold text-teal-700">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <p id="auth-subtitle" class="text-gray-600 mt-2 mb-6">ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="email" id="email-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <button type="submit" id="auth-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </form>
                <div id="auth-error" class="hidden mt-4 text-red-600 text-sm"></div>
                <div id="auth-success" class="hidden mt-4 text-green-700 text-sm"></div>
                <p class="mt-6 text-sm text-gray-600">
                    <span id="auth-prompt-text">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ</span>
                    <a href="#" id="toggle-auth-mode" class="font-medium text-teal-600 hover:text-teal-500">æ–°è¦ç™»éŒ²</a>
                </p>
            </div>
        </div>

        <!-- 3. MFAã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ -->
        <div id="mfa-verify-section" class="auth-container hidden">
            <div class="auth-card text-center">
                <h2 class="text-2xl font-bold text-teal-700">èªè¨¼ã‚³ãƒ¼ãƒ‰ã®å…¥åŠ›</h2>
                <p class="text-gray-600 mt-2 mb-6">èªè¨¼ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚ŒãŸ6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <form id="mfa-verify-form" class="space-y-4">
                    <input type="text" id="mfa-code-input" placeholder="6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" inputmode="numeric" pattern="\d{6}" autocomplete="one-time-code">
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                        èªè¨¼
                    </button>
                </form>
                <div id="mfa-verify-error" class="hidden mt-4 text-red-600 text-sm"></div>
                 <button id="mfa-verify-cancel" class="mt-4 text-sm text-gray-500 hover:text-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <!-- 4. MFAå¼·åˆ¶è¨­å®šç”»é¢ -->
        <div id="mfa-setup-section" class="auth-container hidden">
            <div class="auth-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">MFAè¨­å®šãŒå¿…è¦ã§ã™</h2>
                <p class="text-gray-600 mb-4 text-center">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã€å¤šè¦ç´ èªè¨¼(MFA)ã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
                <ol class="list-decimal list-inside text-gray-600 space-y-2 mb-6 bg-gray-50 p-4 rounded-lg">
                    <li>Google Authenticatorç­‰ã®èªè¨¼ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</li>
                    <li>ã‚¢ãƒ—ãƒªã§ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ã€‚</li>
                    <li>ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚ŒãŸ6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€ã€Œæœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</li>
                </ol>
                <div id="mfa-qr-code" class="bg-white p-4 border rounded-lg flex justify-center items-center mb-4 w-48 h-48 mx-auto">
                    <!-- QRã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°/ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <form id="mfa-setup-form">
                    <input type="text" id="mfa-setup-code-input" placeholder="6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" inputmode="numeric" pattern="\d{6}" autocomplete="one-time-code">
                    <div id="mfa-setup-error" class="text-red-600 text-sm mt-2 hidden"></div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="mfa-setup-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded transition-colors">æœ‰åŠ¹åŒ–ã—ã¦åˆ©ç”¨é–‹å§‹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¦ç´  (å¤‰æ›´ãªã—) -->
    <div id="tooltip">
        <h4 id="tooltip-title"></h4>
        <p id="tooltip-desc"></p>
        <div id="tooltip-formula" class="formula"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ===== Element Selectors =====
    const appContainer = document.getElementById('app-container');
    const logoutButton = document.getElementById('logout-button');
    const authContainer = document.getElementById('auth-container');
    const loadingSection = document.getElementById('loading-section');
    const loginSection = document.getElementById('login-section');
    const mfaVerifySection = document.getElementById('mfa-verify-section');
    const mfaSetupSection = document.getElementById('mfa-setup-section');
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const authTitle = document.getElementById('auth-title');
    const authSubtitle = document.getElementById('auth-subtitle');
    const authButton = document.getElementById('auth-button');
    const authPromptText = document.getElementById('auth-prompt-text');
    const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
    const authError = document.getElementById('auth-error');
    const authSuccess = document.getElementById('auth-success');
    const mfaVerifyForm = document.getElementById('mfa-verify-form');
    const mfaCodeInput = document.getElementById('mfa-code-input');
    const mfaVerifyError = document.getElementById('mfa-verify-error');
    const mfaVerifyCancel = document.getElementById('mfa-verify-cancel');
    const mfaSetupForm = document.getElementById('mfa-setup-form');
    const mfaQrCodeContainer = document.getElementById('mfa-qr-code');
    const mfaSetupCodeInput = document.getElementById('mfa-setup-code-input');
    const mfaSetupError = document.getElementById('mfa-setup-error');
    const mfaSetupCancel = document.getElementById('mfa-setup-cancel');

    // ===== State Management =====
    let plannerInitialized = false;
    let isSignUpMode = false;
    let mfaChallengeData = null;
    let tempFactorId = null;
    let isCheckingAuth = false;

    // ===== Supabase Client Initialization =====
    const supabaseUrl = 'https://lltqbacrgrwcrkguiktf.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsdHFiYWNyZ3J3Y3JrZ3Vpa3RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1NTg4MjgsImV4cCI6MjA2NzEzNDgyOH0.Y6OCU7Z-SIO1G2k-EcBKd2vlp8uiqHFHBYxRSsLs52o';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    // ===== UI Update Function =====
    const updateUI = (state) => {
        authContainer.classList.add('hidden');
        loadingSection.classList.add('hidden');
        loginSection.classList.add('hidden');
        mfaVerifySection.classList.add('hidden');
        mfaSetupSection.classList.add('hidden');
        appContainer.classList.add('hidden');
        
        switch (state) {
            case 'LOADING':
                authContainer.classList.remove('hidden');
                loadingSection.classList.remove('hidden');
                break;
            case 'LOGIN':
                authContainer.classList.remove('hidden');
                loginSection.classList.remove('hidden');
                break;
            case 'MFA_VERIFY':
                authContainer.classList.remove('hidden');
                mfaVerifySection.classList.remove('hidden');
                break;
            case 'MFA_SETUP':
                authContainer.classList.remove('hidden');
                mfaSetupSection.classList.remove('hidden');
                startMfaSetup();
                break;
            case 'APP':
                appContainer.classList.remove('hidden');
                if (!plannerInitialized) {
                    initializePlanner();
                    plannerInitialized = true;
                }
                break;
        }
    };

    // ===== Authentication Logic =====
    
    const checkAuthStatus = async () => {
        if (isCheckingAuth) {
            console.log('%cèªè¨¼ãƒã‚§ãƒƒã‚¯ã¯æ—¢ã«é€²è¡Œä¸­ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚', 'color: gray');
            return;
        }
        isCheckingAuth = true;
        console.log('%cèªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™...', 'color: green; font-weight: bold');

        try {
            updateUI('LOADING');
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            if (sessionError) throw sessionError;

            // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆ -> ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
            if (!session) {
                console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
                updateUI('LOGIN');
                return;
            }

            // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€MFAã®èªè¨¼ãƒ¬ãƒ™ãƒ«ã‚’ç¢ºèª
            const { data: aalData, error: aalError } = await supabaseClient.auth.mfa.getAuthenticatorAssuranceLevel();
            if (aalError) throw aalError;

            // 3. MFAèªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆ (aal2) -> ã‚¢ãƒ—ãƒªæœ¬ä½“ã¸
            if (aalData.currentLevel === 'aal2') {
                console.log('MFAèªè¨¼æ¸ˆã¿ã§ã™(aal2)ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
                updateUI('APP');
            } else { 
                // 4. MFAèªè¨¼ãŒæœªå®Œäº†ã®å ´åˆ (aal1)
                console.log('MFAèªè¨¼ãŒæœªå®Œäº†ã§ã™(aal1)ã€‚MFAè¦ç´ ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚');
                const { data: factorsData, error: factorsError } = await supabaseClient.auth.mfa.listFactors();
                if (factorsError) throw factorsError;
                
                const hasVerifiedFactor = factorsData.all.some(factor => factor.status === 'verified');

                // â˜…â˜…â˜… ã“ã“ãŒä»Šå›ã®ä¿®æ­£ã®æ ¸ã¨ãªã‚‹éƒ¨åˆ†ã§ã™ â˜…â˜…â˜…
                if (hasVerifiedFactor) {
                    // 4a. MFAè¦ç´ ã¯è¨­å®šæ¸ˆã¿ã ãŒã€ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯æœªèªè¨¼ã®çŠ¶æ…‹ã€‚
                    // (ä¾‹: MFAã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã‚±ãƒ¼ã‚¹)
                    // ã“ã®å ´åˆã€MFAã®ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¤±ã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®‰å…¨ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã¦å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã—ã¾ã™ã€‚
                    console.log('%cMFAã¯è¨­å®šæ¸ˆã¿ã§ã™ãŒã€ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯æœªèªè¨¼ã§ã™ã€‚å†èªè¨¼ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚', 'color: orange; font-weight: bold;');
                    
                    try {
                        await supabaseClient.auth.signOut();
                        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                        authError.textContent = 'èªè¨¼ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                        authError.classList.remove('hidden');
                        updateUI('LOGIN');
                    } catch (signOutError) {
                        console.error('å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', signOutError);
                        // ä¸‡ãŒä¸€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã‚‚ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚
                        updateUI('LOGIN');
                    }
                } else {
                    // 4b. MFAè¦ç´ ãŒæœªè¨­å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æ–°è¦è¨­å®šãƒ•ãƒ­ãƒ¼ã¸é€²ã¿ã¾ã™ã€‚
                    console.log('æ¤œè¨¼æ¸ˆã¿ã®MFAè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚MFAè¨­å®šç”»é¢ã¸é€²ã¿ã¾ã™ã€‚');
                    updateUI('MFA_SETUP');
                }
            }
        } catch (error) {
            console.error('èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            await supabaseClient.auth.signOut();
            updateUI('LOGIN');
        } finally {
            console.log('%cèªè¨¼ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'color: green; font-weight: bold');
            isCheckingAuth = false;
        }
    };
    
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        authError.textContent = '';
        authError.classList.add('hidden');
        authSuccess.textContent = '';
        authSuccess.classList.add('hidden');
        authButton.disabled = true;
        authButton.textContent = isSignUpMode ? 'ç™»éŒ²ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

        const email = emailInput.value;
        const password = passwordInput.value;

        try {
            if (isSignUpMode) {
                const { error } = await supabaseClient.auth.signUp({ 
                    email, 
                    password,
                    options: { emailRedirectTo: `${window.location.origin}/auth-verify.html` }
                });
                if (error) throw error;
                authSuccess.textContent = 'ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚';
                authSuccess.classList.remove('hidden');
            } else {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                if (data.session === null && data.nextStep?.kind === 'mfa') {
                    console.log("MFAèªè¨¼ãŒå¿…è¦ã§ã™ã€‚èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
                    mfaChallengeData = data.mfa;
                    updateUI('MFA_VERIFY');
                } else if (data.session) {
                    console.log("ç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸã€‚onAuthStateChangeãŒå¾Œç¶šå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚");
                }
            }
        } catch (error) {
            authError.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            authError.classList.remove('hidden');
        } finally {
            authButton.disabled = false;
            authButton.textContent = isSignUpMode ? 'æ–°è¦ç™»éŒ²' : 'ãƒ­ã‚°ã‚¤ãƒ³';
        }
    });

    mfaVerifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        mfaVerifyError.classList.add('hidden');
        const mfaCode = mfaCodeInput.value;

        if (!mfaChallengeData) {
            mfaVerifyError.textContent = 'èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
            mfaVerifyError.classList.remove('hidden');
            return;
        }

        const { error } = await supabaseClient.auth.mfa.challengeAndVerify({
            mfaToken: mfaChallengeData.mfa_token,
            code: mfaCode
        });

        if (error) {
            mfaVerifyError.textContent = `èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            mfaVerifyError.classList.remove('hidden');
        } else {
            mfaChallengeData = null;
            // æˆåŠŸã—ãŸå ´åˆã€onAuthStateChangeãŒç™ºç«ã—ã€aal2ã«ãªã‚‹ã®ã§checkAuthStatusãŒAPPç”»é¢ã«é·ç§»ã•ã›ã¾ã™ã€‚
        }
    });

    const startMfaSetup = async () => {
        console.log('%c--- MFAè¨­å®šãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ ---', 'color: blue; font-weight: bold;');
        mfaSetupError.classList.add('hidden');
        mfaQrCodeContainer.innerHTML = '<div class="flex items-center justify-center h-full"><div class="loader"></div><p class="ml-4 text-sm text-gray-600">æº–å‚™ä¸­...</p></div>';

        try {
            console.log('1. æ—¢å­˜ã®MFAè¦ç´ ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™...');
            const { data: factorsData, error: listError } = await supabaseClient.auth.mfa.listFactors();
            if (listError) throw new Error(`æ—¢å­˜è¨­å®šã®ç¢ºèªã«å¤±æ•—: ${listError.message}`);
            console.log('   => å–å¾—ã—ãŸå…¨è¦ç´ :', factorsData.all);

            const unverifiedFactors = factorsData.all.filter(factor => factor.status === 'unverified');
            console.log(`2. æœªæ¤œè¨¼ã®MFAè¦ç´ ãŒ ${unverifiedFactors.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`);

            if (unverifiedFactors.length > 0) {
                console.log('%c3. æœªæ¤œè¨¼ã®MFAè¦ç´ ã‚’å‰Šé™¤ã—ã¾ã™...', 'color: orange;');
                const unenrollPromises = unverifiedFactors.map(factor => supabaseClient.auth.mfa.unenroll({ factorId: factor.id }));
                await Promise.all(unenrollPromises);
                console.log('%c   => æœªæ¤œè¨¼è¦ç´ ã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'color: orange;');
            } else {
                console.log('3. å‰Šé™¤å¯¾è±¡ã®æœªæ¤œè¨¼MFAè¦ç´ ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }

            console.log('4. æ–°ã—ã„MFAè¦ç´ ã‚’ç™»éŒ²ã—ã¾ã™...');
            const { data: enrollData, error: enrollError } = await supabaseClient.auth.mfa.enroll({ factorType: 'totp' });
            if (enrollError) throw new Error(`MFAã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ: ${enrollError.message}`);
            console.log('%c5. æ–°ã—ã„MFAè¦ç´ ã®ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'color: green;');
            
            tempFactorId = enrollData.id;
            const qrCodeUri = enrollData.totp.qr_code;
            mfaQrCodeContainer.innerHTML = '';
            const qrImage = document.createElement('img');
            qrImage.src = qrCodeUri;
            qrImage.alt = 'MFA QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„';
            qrImage.className = 'w-full h-full object-contain';
            mfaQrCodeContainer.appendChild(qrImage);
            console.log('6. QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚');

        } catch (error) {
            console.error('%c--- MFAè¨­å®šãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ ---', 'color: red; font-weight: bold;', error);
            mfaQrCodeContainer.innerHTML = '';
            mfaSetupError.textContent = `è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ (${error.message})`;
            mfaSetupError.classList.remove('hidden');
        }
    };

    mfaSetupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        mfaSetupError.classList.add('hidden');
        const code = mfaSetupCodeInput.value;
        
        if (!tempFactorId) {
            mfaSetupError.textContent = 'æ¤œè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
            mfaSetupError.classList.remove('hidden');
            return;
        }
        
        const { error } = await supabaseClient.auth.mfa.challengeAndVerify({
            factorId: tempFactorId,
            code: code,
        });

        if (error) {
            mfaSetupError.textContent = `æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            mfaSetupError.classList.remove('hidden');
        } else {
            tempFactorId = null; 
            // æˆåŠŸã—ãŸå ´åˆã€onAuthStateChangeãŒç™ºç«ã—ã€aal2ã«ãªã‚‹ã®ã§checkAuthStatusãŒAPPç”»é¢ã«é·ç§»ã•ã›ã¾ã™ã€‚
        }
    });

    // ===== Event Listeners for UI toggles and logout =====
    toggleAuthModeLink.addEventListener('click', (e) => {
        e.preventDefault();
        isSignUpMode = !isSignUpMode;
        loginForm.reset();
        authError.classList.add('hidden');
        authSuccess.classList.add('hidden');
        
        if (isSignUpMode) {
            authTitle.textContent = 'æ–°è¦ç™»éŒ²';
            authSubtitle.textContent = 'ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯æ–°è¦ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚';
            authButton.textContent = 'æ–°è¦ç™»éŒ²';
            authPromptText.textContent = 'ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ';
            toggleAuthModeLink.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        } else {
            authTitle.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            authSubtitle.textContent = 'ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
            authButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            authPromptText.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ';
            toggleAuthModeLink.textContent = 'æ–°è¦ç™»éŒ²';
        }
    });

    const handleLogout = async () => {
        await supabaseClient.auth.signOut();
    };
    logoutButton.addEventListener('click', handleLogout);
    mfaSetupCancel.addEventListener('click', handleLogout);
    mfaVerifyCancel.addEventListener('click', handleLogout);

    supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log(`èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã¾ã—ãŸ: ${event}`);
        checkAuthStatus();
    });

    // ===================================================================
    // ===== APPLICATION CORE LOGIC (No changes below this line) =====
    // ===================================================================
    function initializePlanner() {
        // ã‚¬ãƒ¼ãƒ‰ç¯€: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã‘ã‚Œã°åˆæœŸåŒ–ã—ãªã„
        if (appContainer.classList.contains('hidden')) {
            console.warn('%cinitializePlannerãŒå‘¼ã°ã‚Œã¾ã—ãŸãŒã€appContainerãŒéè¡¨ç¤ºã®ãŸã‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚', 'color: orange;');
            return;
        }
        console.log('%c--- initializePlanner é–‹å§‹ ---', 'color: purple; font-weight: bold;');

        const data = {
            caseStudies: [
                { id: 'fitness-24h', title: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', subtitle: '24æ™‚é–“å–¶æ¥­ã‚¸ãƒ ', targetProfit: 600000, avgCustomerValue: 38400, cogs: 10000, profitPerCv: 8000, cvr: 3.5, cpc: 250, description: 'é§…è¿‘ã§ä¾¿åˆ©ãª24æ™‚é–“å–¶æ¥­ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¸ãƒ ã€‚æœ€æ–°ãƒã‚·ãƒ³å®Œå‚™ã§ã€æœˆé¡8,000å††ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã€‚è¦‹å­¦äºˆç´„å—ä»˜ä¸­ã€‚' },
                { id: 'fitness-yoga', title: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', subtitle: 'å¥³æ€§å°‚ç”¨ãƒ›ãƒƒãƒˆãƒ¨ã‚¬', targetProfit: 450000, avgCustomerValue: 60000, cogs: 20000, profitPerCv: 15000, cvr: 2.5, cpc: 180, description: 'åˆå¿ƒè€…æ­“è¿ã®å¥³æ€§å°‚ç”¨ãƒ›ãƒƒãƒˆãƒ¨ã‚¬ã‚¹ã‚¿ã‚¸ã‚ªã€‚ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ã¨ãƒªãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœã§å¿ƒã‚‚ä½“ã‚‚ç¾ã—ãã€‚ä½“é¨“ãƒ¬ãƒƒã‚¹ãƒ³å—ä»˜ä¸­ã€‚' },
                { id: 'fitness-online', title: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', subtitle: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«', targetProfit: 400000, avgCustomerValue: 25000, cogs: 5000, profitPerCv: 10000, cvr: 2.0, cpc: 300, description: 'è‡ªå®…ã§å—ã‘ã‚‰ã‚Œã‚‹æœ¬æ ¼çš„ãªã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚ã‚ãªãŸå°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ç†æƒ³ã®èº«ä½“ã¸ã€‚ç„¡æ–™ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°å®Ÿæ–½ä¸­ã€‚' },
                { id: 'tutor-elem', title: 'å­¦ç¿’å¡¾', subtitle: 'å°å­¦ç”Ÿå‘ã‘é›†å›£æŒ‡å°', targetProfit: 500000, avgCustomerValue: 48000, cogs: 20000, profitPerCv: 10000, cvr: 1.5, cpc: 300, description: 'åœ°åŸŸå¯†ç€å‹ã®å°å­¦ç”Ÿå‘ã‘å­¦ç¿’å¡¾ã€‚ã‚ã‹ã‚‹ã¾ã§å¾¹åº•æŒ‡å°ã§ã€å‹‰å¼·ãŒæ¥½ã—ããªã‚‹ã€‚ã¾ãšã¯è³‡æ–™è«‹æ±‚ã‹ã‚‰ã€‚' },
                { id: 'tutor-univ', title: 'å­¦ç¿’å¡¾', subtitle: 'å¤§å­¦å—é¨“äºˆå‚™æ ¡', targetProfit: 1350000, avgCustomerValue: 150000, cogs: 60000, profitPerCv: 45000, cvr: 2.5, cpc: 550, description: 'é›£é–¢å¤§å­¦ã‚’ç›®æŒ‡ã™é«˜æ ¡ç”Ÿã®ãŸã‚ã®å¤§å­¦å—é¨“äºˆå‚™æ ¡ã€‚ãƒ—ãƒ­è¬›å¸«é™£ã«ã‚ˆã‚‹è³ªã®é«˜ã„æˆæ¥­ã¨æ‰‹åšã„ã‚µãƒãƒ¼ãƒˆã€‚å€‹åˆ¥ç›¸è«‡ä¼šã‚’äºˆç´„ã€‚' },
                { id: 'tutor-prog', title: 'å­¦ç¿’å¡¾', subtitle: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¯ãƒ¼ãƒ«', targetProfit: 1000000, avgCustomerValue: 60000, cogs: 10000, profitPerCv: 20000, cvr: 3.0, cpc: 700, description: 'æœªçµŒé¨“ã‹ã‚‰ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã€‚è»¢è·ä¿è¨¼ä»˜ãã®ç¤¾ä¼šäººå‘ã‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¯ãƒ¼ãƒ«ã€‚ã¾ãšã¯ç„¡æ–™ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ã¸ã€‚' },
                { id: 'buyback-brand', title: 'è²·å–ã‚µãƒ¼ãƒ“ã‚¹', subtitle: 'ãƒ–ãƒ©ãƒ³ãƒ‰å“å®…é…è²·å–', targetProfit: 400000, avgCustomerValue: 9000, cogs: 0, profitPerCv: 4000, cvr: 5.0, cpc: 400, description: 'é€æ–™ç„¡æ–™ã€æ‰‹æ•°æ–™ç„¡æ–™ã®ãƒ–ãƒ©ãƒ³ãƒ‰å“å®…é…è²·å–ã‚µãƒ¼ãƒ“ã‚¹ã€‚ç®±ã«è©°ã‚ã¦é€ã‚‹ã ã‘ã§ç°¡å˜æŸ»å®šã€‚å®…é…ã‚­ãƒƒãƒˆã‚’ç”³ã—è¾¼ã‚€ã€‚' },
                { id: 'buyback-car', title: 'è²·å–ã‚µãƒ¼ãƒ“ã‚¹', subtitle: 'ä¸­å¤è»Šä¸€æ‹¬æŸ»å®š', targetProfit: 1000000, avgCustomerValue: 5000, cogs: 0, profitPerCv: 2000, cvr: 8.0, cpc: 200, description: 'æ„›è»Šã®æœ€é«˜é¡ãŒã‚ã‹ã‚‹ï¼è¤‡æ•°ã®è²·å–æ¥­è€…ã«ä¸€æ‹¬ã§æŸ»å®šã‚’ä¾é ¼ã§ãã‚‹ç„¡æ–™ã‚µãƒ¼ãƒ“ã‚¹ã€‚' },
                { id: 'buyback-book', title: 'è²·å–ã‚µãƒ¼ãƒ“ã‚¹', subtitle: 'å¤æœ¬ãƒ»ã‚²ãƒ¼ãƒ å‡ºå¼µè²·å–', targetProfit: 160000, avgCustomerValue: 3600, cogs: 0, profitPerCv: 1600, cvr: 4.0, cpc: 80, description: 'æœ¬ãƒ»æ¼«ç”»ãƒ»ã‚²ãƒ¼ãƒ ã€30ç‚¹ã‹ã‚‰ç„¡æ–™ã§å‡ºå¼µè²·å–ã€‚ç„é–¢å…ˆã§æŸ»å®šã€ãã®å ´ã§ç¾é‡‘æ‰•ã„ã€‚' },
                { id: 'real-estate', title: 'ä¸å‹•ç”£', subtitle: 'è³ƒè²¸ä»²ä»‹ï¼ˆå•ã„åˆã‚ã›ï¼‰', targetProfit: 600000, avgCustomerValue: 30000, cogs: 0, profitPerCv: 15000, cvr: 2.5, cpc: 300, description: 'éƒ½å¿ƒã‚¨ãƒªã‚¢ã®å˜èº«è€…å‘ã‘è³ƒè²¸ç‰©ä»¶ã‚’å°‚é–€ã«æ‰±ã†ä¸å‹•ç”£ä»²ä»‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å†…è¦‹ã«ã‚‚å¯¾å¿œã€‚' },
                { id: 'real-estate-invest', title: 'ä¸å‹•ç”£', subtitle: 'æŠ•è³‡ç”¨ç‰©ä»¶ï¼ˆè³‡æ–™è«‹æ±‚ï¼‰', targetProfit: 2000000, avgCustomerValue: 10000, cogs: 0, profitPerCv: 5000, cvr: 4.0, cpc: 300, description: 'å°†æ¥ã®ãŸã‚ã®è³‡ç”£å½¢æˆã€‚éƒ½å¿ƒã®ä¸­å¤ãƒãƒ³ã‚·ãƒ§ãƒ³ã‚’ä¸­å¿ƒã¨ã—ãŸæŠ•è³‡ç”¨ä¸å‹•ç”£ã®ã”ææ¡ˆã€‚ã¾ãšã¯ç„¡æ–™ã®è³‡æ–™è«‹æ±‚ã‹ã‚‰ã€‚' },
                { id: 'real-estate-new', title: 'ä¸å‹•ç”£', subtitle: 'æ–°ç¯‰æˆ¸å»ºã¦ï¼ˆè¦‹å­¦äºˆç´„ï¼‰', targetProfit: 1500000, avgCustomerValue: 50000, cogs: 0, profitPerCv: 25000, cvr: 1.5, cpc: 650, description: 'å®¶æ—ã®å¤¢ã‚’å¶ãˆã‚‹ã€ãƒ‡ã‚¶ã‚¤ãƒ³æ€§ã®é«˜ã„æ–°ç¯‰æˆ¸å»ºã¦ã€‚é€±æœ«ã®è¦‹å­¦ä¼šã‚’äºˆç´„ã—ã¦ã€ç†æƒ³ã®ä½ã¾ã„ã‚’ä½“æ„Ÿã—ã¦ãã ã•ã„ã€‚' },
                { id: 'b2c-ec', title: 'B2C Eã‚³ãƒãƒ¼ã‚¹', subtitle: 'ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼', targetProfit: 150000, avgCustomerValue: 6000, cogs: 1000, profitPerCv: 2000, cvr: 2.0, cpc: 80, description: '20ä»£å¥³æ€§å‘ã‘ã®ã€é«˜å“è³ªãªå¤©ç„¶çŸ³ã‚’ä½¿ã£ãŸãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆã‚¢ã€‚' },
                { id: 'b2b-saas', title: 'B2B SaaS', subtitle: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚½ãƒ•ãƒˆ', targetProfit: 1080000, avgCustomerValue: 60000, cogs: 0, profitPerCv: 36000, cvr: 2.0, cpc: 600, description: 'ä¸­å°ä¼æ¥­ãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—å‘ã‘ã®ç›´æ„Ÿçš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†SaaSãƒ„ãƒ¼ãƒ«ã€‚ã‚¿ã‚¹ã‚¯ç®¡ç†ã€ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã€ãƒãƒ¼ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›ã€‚' },
                { id: 'high-ticket', title: 'é«˜ä¾¡æ ¼å¸¯B2C', subtitle: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è‹±ä¼šè©±', targetProfit: 1800000, avgCustomerValue: 24000, cogs: 0, profitPerCv: 12000, cvr: 3.0, cpc: 350, description: 'ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ã‚½ãƒ³å‘ã‘ã®ãƒãƒ³ãƒ„ãƒ¼ãƒãƒ³ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è‹±ä¼šè©±ã‚¹ã‚¯ãƒ¼ãƒ«ã€‚ãƒã‚¤ãƒ†ã‚£ãƒ–è¬›å¸«ã«ã‚ˆã‚‹é«˜å“è³ªãªãƒ¬ãƒƒã‚¹ãƒ³ãŒç‰¹å¾´ã€‚' }
            ],
            benchmarks: {
                googleSearch: { 
                    name: 'Googleæ¤œç´¢', 
                    headers: ['æ¥­ç•Œ', 'å¹³å‡CPC', 'å¹³å‡CVR (æ¤œç´¢)', 'å¹³å‡CPA (æ¤œç´¢)'], 
                    rows: [ 
                        ['BtoB', '450å†† - 600å††', '3.04%', '15,000å†† - 20,000å††'], 
                        ['Eã‚³ãƒãƒ¼ã‚¹', '150å†† - 300å††', '2.81%', '6,000å†† - 9,000å††'], 
                        ['æ•™è‚²ãƒ»å­¦ç¿’', '250å†† - 400å††', '3.39%', '10,000å†† - 15,000å††'],
                        ['é‡‘èãƒ»ä¿é™º', '350å†† - 800å††', '5.10%', '8,000å†† - 13,000å††'], 
                        ['å¥åº·ãƒ»åŒ»ç™‚', '300å†† - 500å††', '3.36%', '9,000å†† - 12,000å††'],
                        ['ç¾å®¹ãƒ»ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', '200å†† - 450å††', '3.80%', '7,000å†† - 11,000å††'],
                        ['äººæãƒ»æ¡ç”¨', '400å†† - 700å††', '5.13%', '6,000å†† - 9,000å††'],
                        ['ä¸å‹•ç”£', '300å†† - 700å††', '2.47%', '15,000å†† - 20,000å††'],
                        ['ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼', '400å†† - 650å††', '2.92%', '14,000å†† - 22,000å††'],
                        ['æ—…è¡Œãƒ»è¦³å…‰', '150å†† - 300å††', '4.68%', '5,000å†† - 8,000å††'],
                    ] 
                },
                meta: { 
                    name: 'Metaåºƒå‘Š', 
                    headers: ['æ¥­ç•Œ', 'å¹³å‡CPC', 'å¹³å‡CVR', 'å¹³å‡CPA'], 
                    rows: [ 
                        ['ã‚¢ãƒ‘ãƒ¬ãƒ«ãƒ»EC', '80å†† - 200å††', '4.11%', '1,200å†† - 3,000å††'], 
                        ['ç¾å®¹ãƒ»ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', '100å†† - 300å††', '11.29%', '2,500å†† - 5,000å††'], 
                        ['æ•™è‚²ãƒ»å­¦ç¿’', '150å†† - 400å††', '13.58%', '8,000å†† - 15,000å††'], 
                        ['é‡‘èãƒ»ä¿é™º', '300å†† - 700å††', '9.09%', '18,000å†† - 25,000å††'], 
                        ['BtoB', '250å†† - 500å††', '10.63%', '10,000å†† - 20,000å††'], 
                        ['ä¸å‹•ç”£', '200å†† - 600å††', '10.67%', '10,000å†† - 18,000å††'],
                        ['åŒ»ç™‚ãƒ»å¥åº·', '180å†† - 450å††', '11.00%', '7,000å†† - 13,000å††'],
                        ['äººæãƒ»æ¡ç”¨', '150å†† - 350å††', '9.50%', '5,000å†† - 10,000å††'],
                        ['æ—…è¡Œãƒ»è¦³å…‰', '70å†† - 180å††', '5.50%', '3,000å†† - 6,000å††'],
                    ] 
                },
                x: { 
                    name: 'X (æ—§Twitter)', 
                    headers: ['æŒ‡æ¨™', 'å¹³å‡å€¤ï¼ˆç›®å®‰ï¼‰', 'å‚™è€ƒ'], 
                    rows: [
                        ['CPC (ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡)', '40å†† - 120å††', 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç›®çš„ã«ã‚ˆã‚Šå¤§ããå¤‰å‹•'],
                        ['CPM (ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å˜ä¾¡)', '600å†† - 900å††', 'ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã§å¤‰å‹•'],
                        ['CPE (ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå˜ä¾¡)', '30å†† - 70å††', 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç›®çš„ã®å ´åˆ'],
                        ['CVR (ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡)', '0.5% - 2.0%', 'å•†å“ã‚„è¨´æ±‚å†…å®¹ã«å¤§ããä¾å­˜'],
                        ['CPI (ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å˜ä¾¡)', '150å†† - 400å††', 'ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«åºƒå‘Šã®å ´åˆ'],
                    ]
                },
                tiktok: {
                    name: 'TikTokåºƒå‘Š',
                    headers: ['æŒ‡æ¨™', 'å¹³å‡å€¤ï¼ˆç›®å®‰ï¼‰', 'å‚™è€ƒ'],
                    rows: [
                        ['CPM (ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å˜ä¾¡)', '200å†† - 800å††', 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã®è³ªã§å¤§ããå¤‰å‹•'],
                        ['CPC (ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡)', '30å†† - 100å††', 'è‹¥å¹´å±¤å‘ã‘å•†æã§åŠ¹ç‡ãŒè‰¯ã„å‚¾å‘'],
                        ['CVR (ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡)', '0.5% - 3.0%', 'å‹•ç”»ã®å†’é ­ã§èˆˆå‘³ã‚’å¼•ãã“ã¨ãŒé‡è¦'],
                        ['CPV (è¦–è´å˜ä¾¡)', '3å†† - 10å††', 'å‹•ç”»è¦–è´ç›®çš„ã®å ´åˆ'],
                    ]
                },
                line: { 
                    name: 'LINEåºƒå‘Š', 
                    headers: ['èª²é‡‘æ–¹å¼', 'è²»ç”¨æ„Ÿã®ç›®å®‰', 'ç‰¹å¾´'], 
                    rows: [ 
                        ['ã‚¯ãƒªãƒƒã‚¯èª²é‡‘ (CPC)', '30å††ï½150å††', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã¸ã®èª˜å°ã«æœ€é©'], 
                        ['ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³èª²é‡‘ (CPM)', '500å††ï½1,200å††', 'å¹…åºƒã„èªçŸ¥ç²å¾—å‘ã‘'], 
                        ['å‹ã ã¡è¿½åŠ èª²é‡‘ (CPF)', '100å††ï½300å††', 'è¦‹è¾¼ã¿é¡§å®¢ãƒªã‚¹ãƒˆã®æ§‹ç¯‰ã«æœ€é©'], 
                    ] 
                }
            },
            optimization: [
                { title: 'å•é¡Œï¼šCTRï¼ˆã‚¯ãƒªãƒƒã‚¯ç‡ï¼‰ãŒä½ã„', content: `<strong>åŸå› ï¼š</strong>åºƒå‘Šæ–‡ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«éŸ¿ã„ã¦ã„ãªã„ã€ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ãŒåºƒã™ãã‚‹ã€åºƒå‘Šã¨æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é–¢é€£æ€§ãŒä½ã„ã€ãªã©ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<br><br><strong>è§£æ±ºç­–ï¼š</strong><br>1. <strong>A/Bãƒ†ã‚¹ãƒˆã®å®Ÿæ–½ï¼š</strong>åºƒå‘Šã®è¦‹å‡ºã—ã‚„èª¬æ˜æ–‡ã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨æ„ã—ã€ã©ã¡ã‚‰ãŒã‚ˆã‚Šé«˜ã„CTRã‚’ç²å¾—ã§ãã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚<br>2. <strong>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¦‹ç›´ã—ï¼š</strong>é–¢é€£æ€§ã®ä½ã„æ¤œç´¢èªå¥ã‚’é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦è¨­å®šã—ã€ãƒãƒƒãƒã‚¿ã‚¤ãƒ—ã‚’ã‚ˆã‚Šå…·ä½“çš„ã«çµã‚Šè¾¼ã¿ã¾ã™ã€‚<br>3. <strong>åºƒå‘Šè¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ´»ç”¨ï¼š</strong>ã‚µã‚¤ãƒˆãƒªãƒ³ã‚¯ãªã©ã‚’è¿½åŠ ã—ã€åºƒå‘Šã®è¡¨ç¤ºé¢ç©ã‚’åºƒã’ã€ã‚ˆã‚Šå¤šãã®æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚` },
                { title: 'å•é¡Œï¼šCVRï¼ˆã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ï¼‰ãŒä½ã„', content: `<strong>åŸå› ï¼š</strong>åºƒå‘Šã®è¨´æ±‚å†…å®¹ã¨ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆLPï¼‰ã®å†…å®¹ãŒä¸€è‡´ã—ã¦ã„ãªã„ã€LPã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼ˆUXï¼‰ãŒæ‚ªã„ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãŒè¤‡é›‘ã€è¡¨ç¤ºé€Ÿåº¦ãŒé…ã„ãªã©ï¼‰ã€CTAï¼ˆè¡Œå‹•å–šèµ·ï¼‰ãŒå¼±ã„ã€ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚<br><br><strong>è§£æ±ºç­–ï¼š</strong><br>1. <strong>LPã®æœ€é©åŒ–ï¼ˆLPOï¼‰ï¼š</strong>åºƒå‘Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨LPã®ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’ä¸€è‡´ã•ã›ã€ä¸€è²«æ€§ã‚’ä¿ã¡ã¾ã™ã€‚<br>2. <strong>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®æœ€é©åŒ–ï¼ˆEFOï¼‰ï¼š</strong>å…¥åŠ›é …ç›®ã‚’æœ€å°é™ã«æ¸›ã‚‰ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è² æ‹…ã‚’è»½æ¸›ã—ã¾ã™ã€‚<br>3. <strong>CTAã®æ”¹å–„ï¼š</strong>ã€Œé€ä¿¡ã€ã§ã¯ãªãã€ã€Œç„¡æ–™ã§ä½“é¨“ãƒ¬ãƒƒã‚¹ãƒ³ã‚’äºˆç´„ã™ã‚‹ã€ãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒªãƒƒãƒˆã‚’å…·ä½“çš„ã«ç¤ºã™æ–‡è¨€ã«ä¿®æ­£ã—ã¾ã™ã€‚` },
                { title: 'å•é¡Œï¼šCPAï¼ˆé¡§å®¢ç²å¾—å˜ä¾¡ï¼‰ãŒé«˜ã„', content: `<strong>åŸå› ï¼š</strong>CPAã¯ <strong>CPC Ã· CVR</strong> ã§ç®—å‡ºã•ã‚Œã‚‹ãŸã‚ã€CPAãŒé«˜ã„ã®ã¯ã€ŒCPCãŒé«˜ã™ãã‚‹ã€ã‹ã€ŒCVRãŒä½ã™ãã‚‹ã€ã€ã‚ã‚‹ã„ã¯ãã®ä¸¡æ–¹ãŒåŸå› ã§ã™ã€‚<br><br><strong>è§£æ±ºç­–ï¼š</strong><br>1. <strong>æ ¹æœ¬åŸå› ã¸ã®å¯¾å‡¦ï¼š</strong>ä¸Šè¨˜ã®CTRæ”¹å–„ç­–ï¼ˆCPCã«å½±éŸ¿ï¼‰ã¨CVRæ”¹å–„ç­–ã‚’å¾¹åº•çš„ã«å®Ÿè¡Œã—ã¾ã™ã€‚<br>2. <strong>å“è³ªã‚¹ã‚³ã‚¢ã®å‘ä¸Šï¼š</strong>Googleåºƒå‘Šã§ã¯ã€åºƒå‘Šãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»LPã®é–¢é€£æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ã§å“è³ªã‚¹ã‚³ã‚¢ãŒå‘ä¸Šã—ã€çµæœã¨ã—ã¦CPCãŒä½ä¸‹ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚<br>3. <strong>é…ä¿¡ã®æœ€é©åŒ–ï¼š</strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ã¸ã®äºˆç®—é…åˆ†ã‚’æ¸›ã‚‰ã—ã€é€†ã«CPAãŒè‰¯å¥½ãªé ˜åŸŸã«äºˆç®—ã‚’é›†ä¸­ã•ã›ã¾ã™ã€‚` }
            ]
        };
        const tooltipData = {
            'limit-cpa': { title: 'é™ç•ŒCPA', desc: '1CVã‚ãŸã‚Šã«ã‹ã‘ã‚‰ã‚Œã‚‹åºƒå‘Šè²»ã®ä¸Šé™é¡ã€‚ã“ã‚Œã‚’è¶…ãˆã‚‹ã¨èµ¤å­—ã«ãªã‚‹æç›Šåˆ†å²ç‚¹ã§ã™ã€‚', formula: 'å¹³å‡é¡§å®¢å˜ä¾¡ - å•†å“åŸä¾¡' },
            'target-cpa': { title: 'ç›®æ¨™CPA', desc: 'ç›®æ¨™åˆ©ç›Šã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€1CVã‚ãŸã‚Šã«è¨±å®¹ã•ã‚Œã‚‹åºƒå‘Šè²»ã€‚å£²ä¸Šç›®æ¨™ï¼ˆãƒ¢ãƒ¼ãƒ‰Bï¼‰ã®å ´åˆã¯ã€é™ç•ŒCPAã¨åŒã˜ã«ãªã‚Šã¾ã™ã€‚', formula: 'é™ç•ŒCPA - ç¢ºä¿ã—ãŸã„åˆ©ç›Š/CV<br>ã¾ãŸã¯<br>å¹³å‡é¡§å®¢å˜ä¾¡ / (ç›®æ¨™ROAS / 100)<br>ã¾ãŸã¯<br>(å¹³å‡é¡§å®¢å˜ä¾¡ - åŸä¾¡) / (ç›®æ¨™ROI/100 + 1)' },
            'required-cv': { title: 'å¿…è¦CVæ•°', desc: 'è¨­å®šã—ãŸç›®æ¨™ï¼ˆåˆ©ç›Šã¾ãŸã¯å£²ä¸Šï¼‰ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªCVã®ä»¶æ•°ã§ã™ã€‚', formula: 'ç›®æ¨™åˆ©ç›Š Ã· (1CVã‚ãŸã‚Šã®åˆ©ç›Š)<br>ã¾ãŸã¯<br>ç›®æ¨™å£²ä¸Š Ã· å¹³å‡é¡§å®¢å˜ä¾¡' },
            'required-budget': { title: 'å¿…è¦åºƒå‘Šäºˆç®—', desc: 'å¿…è¦CVæ•°ã‚’ã€äºˆæ¸¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆCVR, CPCï¼‰ã§é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªåºƒå‘Šè²»ã®ç·é¡ã§ã™ã€‚', formula: 'å¿…è¦CVæ•° Ã— æ¨å®šCPA' },
            'estimated-cpa': { title: 'æ¨å®šCPA', desc: 'å…¥åŠ›ã•ã‚ŒãŸäºˆæ¸¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆCVR, CPCï¼‰ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹ã€ç¾å®Ÿçš„ãªCPAã®è¦‹ç©ã‚‚ã‚Šã§ã™ã€‚', formula: 'æ¨å®šCPC Ã· (æ¨å®šCVR / 100)' },
            'projected-profit': { title: 'äºˆæ¸¬åˆ©ç›Š', desc: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆæ¨å®šCPAï¼‰ã§ç›®æ¨™ã‚’é”æˆã—ãŸå ´åˆã«è¦‹è¾¼ã¾ã‚Œã‚‹ã€æœ€çµ‚çš„ãªåˆ©ç›Šé¡ã§ã™ã€‚ç›®æ¨™åˆ©ç›Šã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚', formula: '(é™ç•ŒCPA - æ¨å®šCPA) Ã— å¿…è¦CVæ•°' },
            'projected-cv': { title: 'äºˆæ¸¬CVæ•°', desc: 'æŠ•ä¸‹å¯èƒ½äºˆç®—ã§ç²å¾—ãŒæœŸå¾…ã§ãã‚‹CVã®ä»¶æ•°ã§ã™ã€‚', formula: 'æŠ•ä¸‹å¯èƒ½äºˆç®— Ã· æ¨å®šCPA' },
            'projected-sales': { title: 'äºˆæ¸¬å£²ä¸Š', desc: 'äºˆæ¸¬CVæ•°ã‹ã‚‰è¦‹è¾¼ã¾ã‚Œã‚‹å£²ä¸Šé¡ã§ã™ã€‚', formula: 'äºˆæ¸¬CVæ•° Ã— å¹³å‡é¡§å®¢å˜ä¾¡' },
            'projected-roi': { title: 'äºˆæ¸¬ROI (%)', desc: 'æŠ•ä¸‹ã—ãŸåºƒå‘Šäºˆç®—ã«å¯¾ã—ã¦ã€ã©ã‚Œã ã‘ã®åˆ©ç›ŠãŒç”Ÿã¾ã‚Œã‚‹ã‹ã®äºˆæ¸¬å€¤ï¼ˆæŠ•è³‡åˆ©ç›Šç‡ï¼‰ã§ã™ã€‚', formula: '(äºˆæ¸¬åˆ©ç›Š Ã· æŠ•ä¸‹å¯èƒ½äºˆç®—) Ã— 100' }
        };
        const navButtons = document.querySelectorAll('.nav-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const simModeButtons = document.querySelectorAll('.sim-mode-btn');
        const simulatorInputs = document.querySelectorAll('.simulator-input');
        const generateCopyBtn = document.getElementById('generateCopyBtn');
        const generateTargetingBtn = document.getElementById('generateTargetingBtn');
        const generateKeywordsBtn = document.getElementById('generateKeywordsBtn');
        const aiResultContainer = document.getElementById('aiResultContainer');
        const productDescriptionInput = document.getElementById('productDescription');
        const adUrlInput = document.getElementById('adUrl');
        const resultsMain = document.getElementById('results-main');
        const resultsScenario = document.getElementById('results-scenario');
        const tooltip = document.getElementById('tooltip');
        let budgetChart;
        let currentMode = 'A';
        let modeA_cpa_calc_method = 'profit';
        let modeD_kpi_choice = 'cv';
        function formatCurrency(value) { return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(Math.round(value)); }
        function formatNumber(value) { return new Intl.NumberFormat('ja-JP').format(Math.round(value)); }
        function calculateAll() {
            switch (currentMode) {
                case 'A': calculateModeA(); break;
                case 'B': calculateModeB(); break;
                case 'C': calculateModeC(); break;
                case 'D': calculateModeD(); break;
            }
        }
        function createInfoIcon(metric) {
            return `<span class="info-icon ml-1 inline-block align-middle" data-metric="${metric}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.316-.68l.738-3.468a.499.499 0 0 1 .47-.323c.09-.002.19.022.26.077a.45.45 0 0 1 .15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984H7.284l.29-.071a.499.499 0 0 1 .316-.68l-.738-3.468a.499.499 0 0 1-.47-.323c-.09.002-.19-.022-.26-.077a.45.45 0 0 1-.15-.318l.305-.984H4.93c-.294 0-.469-.176-.469-.469a.45.45 0 0 1 .15-.318l.305-.984H4.93c-.294 0-.469-.176-.469-.469a.45.45 0 0 1 .15-.318l.305-.984H4.93c-.294 0-.469-.176-.469-.469a.45.45 0 0 1 .15-.318l.305-.984H7.284l-.29.071a.499.499 0 0 1-.316.68l.738 3.468a.499.499 0 0 1 .47.323c.09-.002.19.022.26.077a.45.45 0 0 1 .15.318l.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984H8.93zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                </span>`;
        }
        function getCogs(prefix) {
            const costTypeSelect = document.getElementById(`${prefix}-cost-type`);
            if (!costTypeSelect) return 0;
            const costType = costTypeSelect.value;
            const avgCustomerValue = parseFloat(document.getElementById(`${prefix}-avgCustomerValue`).value) || 0;
            if (costType === 'cogs') {
                return parseFloat(document.getElementById(`${prefix}-cogs`).value) || 0;
            } else {
                const margin = parseFloat(document.getElementById(`${prefix}-margin`).value) || 0;
                return avgCustomerValue * (margin / 100);
            }
        }
        function renderResults(results, analysisHtml = '') {
            const fullWidthItem = results.find(res => res.fullWidth);
            const gridItems = results.filter(res => !res.fullWidth);
            let html = gridItems.map(res => `
                <div class="bg-white p-3 rounded-md shadow-sm text-center flex flex-col justify-center min-h-[90px]">
                    <div class="text-sm text-gray-500 flex items-center justify-center">
                        ${res.label}
                        ${res.metric ? createInfoIcon(res.metric) : ''}
                    </div>
                    <p class="result-value ${res.color || 'text-gray-800'} mt-1">${res.value}</p>
                </div>
            `).join('');
            if(fullWidthItem) {
                html += `<div class="bg-white p-3 rounded-md shadow-sm text-center mt-4 col-span-2">
                    <div class="text-sm text-gray-500 flex items-center justify-center">
                        ${fullWidthItem.label}
                        ${fullWidthItem.metric ? createInfoIcon(fullWidthItem.metric) : ''}
                    </div>
                    <p class="result-value ${fullWidthItem.color || 'text-gray-800'} mt-1">${fullWidthItem.value}</p>
                </div>`;
            }
            html += analysisHtml;
            resultsMain.innerHTML = html;
        }
        function calculateModeA() {
            const targetProfit = parseFloat(document.getElementById('a-targetProfit').value) || 0;
            const avgCustomerValue = parseFloat(document.getElementById('a-avgCustomerValue').value) || 0;
            const cogs = getCogs('a');
            const profitPerCvInput = document.getElementById('a-profitPerCv').value;
            const profitPerCv = profitPerCvInput === '' ? NaN : parseFloat(profitPerCvInput);
            const targetRoas = parseFloat(document.getElementById('a-targetRoas').value) || 0;
            const targetRoi = parseFloat(document.getElementById('a-targetRoi').value) || 0;
            const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
            const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;
            const limitCpa = avgCustomerValue - cogs;
            let targetCpa;
            let requiredCv;
            let warningMessage = '';
            let profitPerUnit = NaN;
            if (modeA_cpa_calc_method === 'profit') {
                targetCpa = isNaN(profitPerCv) ? NaN : limitCpa - profitPerCv;
                profitPerUnit = profitPerCv;
                if (!isNaN(profitPerCv) && profitPerCv <= 0 && targetProfit > 0) {
                    warningMessage = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-2 mt-2 rounded-r-lg" role="alert"><p class="font-bold">æ³¨æ„</p><p>ã€Œç¢ºä¿ã—ãŸã„åˆ©ç›Š/CVã€ãŒ0å††ä»¥ä¸‹ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ©ã‚¹ã®ç›®æ¨™åˆ©ç›Šã‚’é”æˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</p></div>`;
                }
            } else if (modeA_cpa_calc_method === 'roas') {
                 if (targetRoas > 0) {
                    targetCpa = avgCustomerValue / (targetRoas / 100);
                    profitPerUnit = limitCpa - targetCpa;
                    if (profitPerUnit <= 0 && targetProfit > 0) {
                        const breakevenRoas = (avgCustomerValue > 0 && limitCpa > 0) ? (avgCustomerValue / limitCpa) * 100 : 0;
                        warningMessage = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-2 mt-2 rounded-r-lg" role="alert"><p class="font-bold">æ³¨æ„</p><p>ç›®æ¨™ROASãŒä½ã™ãã‚‹ãŸã‚åˆ©ç›ŠãŒå‡ºã¾ã›ã‚“ã€‚ç›®æ¨™åˆ©ç›Šã®é”æˆã¯ä¸å¯èƒ½ã§ã™ã€‚</p><p class="text-sm mt-2">æç›Šåˆ†å²ROAS (åˆ©ç›ŠãŒ0ã«ãªã‚‹ROAS) ã¯ãŠã‚ˆã <strong>${breakevenRoas.toFixed(1)}%</strong> ã§ã™ã€‚</p></div>`;
                    }
                } else {
                    targetCpa = NaN;
                }
            } else if (modeA_cpa_calc_method === 'roi') {
                if (targetRoi > -100) {
                    targetCpa = limitCpa / ((targetRoi / 100) + 1);
                    profitPerUnit = limitCpa - targetCpa;
                     if (profitPerUnit <= 0 && targetProfit > 0) {
                        warningMessage = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-2 mt-2 rounded-r-lg" role="alert"><p class="font-bold">æ³¨æ„</p><p>ç›®æ¨™ROIãŒä½ã™ãã‚‹ãŸã‚åˆ©ç›ŠãŒå‡ºã¾ã›ã‚“ã€‚ç›®æ¨™åˆ©ç›Šã®é”æˆã¯ä¸å¯èƒ½ã§ã™ã€‚</p><p class="text-sm mt-2">æç›Šåˆ†å²ROI (åˆ©ç›ŠãŒ0ã«ãªã‚‹ROI) ã¯ <strong>0%</strong> ã§ã™ã€‚</p></div>`;
                    }
                } else {
                    targetCpa = NaN;
                }
            } else {
                targetCpa = NaN;
            }
            requiredCv = (targetProfit > 0 && profitPerUnit > 0) ? Math.ceil(targetProfit / profitPerUnit) : 0;
            const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
            const requiredBudget = requiredCv * estimatedCpa;
            const projectedProfit = (limitCpa - estimatedCpa) * requiredCv;
            const resultsData = [
                { label: 'é™ç•ŒCPA', value: formatCurrency(Math.max(0, limitCpa)), color: 'text-red-600', metric: 'limit-cpa' },
                { label: 'ç›®æ¨™CPA', value: !isFinite(targetCpa) ? formatCurrency(0) : formatCurrency(Math.max(0, targetCpa)), color: 'text-green-600', metric: 'target-cpa' },
                { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
                { label: 'å¿…è¦CVæ•°', value: `${formatNumber(requiredCv)}ä»¶`, color: 'text-blue-600', metric: 'required-cv' },
                { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
                { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
            ];
            renderResults(resultsData, warningMessage);
            renderScenarioSection(requiredCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
        }
        function calculateModeB() {
            const targetSales = parseFloat(document.getElementById('b-targetSales').value) || 0;
            const avgCustomerValue = parseFloat(document.getElementById('b-avgCustomerValue').value) || 0;
            const cogs = getCogs('b');
            const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
            const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;
            const requiredCv = (targetSales > 0 && avgCustomerValue > 0) ? Math.ceil(targetSales / avgCustomerValue) : 0;
            const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
            const requiredBudget = requiredCv * estimatedCpa;
            const limitCpa = avgCustomerValue - cogs;
            const projectedProfit = (targetSales - (cogs * requiredCv) - requiredBudget);
            const resultsData = [
                { label: 'é™ç•ŒCPA', value: formatCurrency(Math.max(0, limitCpa)), color: 'text-red-600', metric: 'limit-cpa' },
                { label: 'ç›®æ¨™CPA', value: formatCurrency(Math.max(0, limitCpa)), color: 'text-green-600', metric: 'target-cpa' },
                { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
                { label: 'å¿…è¦CVæ•°', value: `${formatNumber(requiredCv)}ä»¶`, color: 'text-blue-600', metric: 'required-cv' },
                { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
                { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
            ];
            renderResults(resultsData);
            renderScenarioSection(requiredCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
        }
        function calculateModeC() {
            const availableBudget = parseFloat(document.getElementById('c-availableBudget').value) || 0;
            const avgCustomerValue = parseFloat(document.getElementById('c-avgCustomerValue').value) || 0;
            const cogs = getCogs('c');
            const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
            const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;
            const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
            const projectedCv = estimatedCpa > 0 ? availableBudget / estimatedCpa : 0;
            const projectedSales = projectedCv * avgCustomerValue;
            const projectedProfit = projectedSales - (projectedCv * cogs) - availableBudget;
            const projectedRoi = availableBudget > 0 ? (projectedProfit / availableBudget) * 100 : 0;
            const resultsData = [
                { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
                { label: 'äºˆæ¸¬CVæ•°', value: `${formatNumber(projectedCv)}ä»¶`, color: 'text-blue-600', metric: 'projected-cv' },
                { label: 'äºˆæ¸¬å£²ä¸Š', value: formatCurrency(projectedSales), color: 'text-teal-600', metric: 'projected-sales' },
                { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
                { label: 'äºˆæ¸¬ROI', value: `${projectedRoi.toFixed(1)}%`, color: 'text-indigo-600', metric: 'projected-roi', fullWidth: true },
            ];
            renderResults(resultsData);
            renderScenarioSection(projectedCv, cvr, cpc, 'äºˆæ¸¬ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•°', formatNumber, 'ä»¶');
        }
        function calculateModeD() {
            const avgCustomerValue = parseFloat(document.getElementById('d-avgCustomerValue').value) || 0;
            const cogs = getCogs('d');
            const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
            const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;
            const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
            let analysisHtml = '';
            if (modeD_kpi_choice === 'cv') {
                const targetCv = parseFloat(document.getElementById('d-targetCv').value) || 0;
                const requiredBudget = targetCv * estimatedCpa;
                const projectedSales = targetCv * avgCustomerValue;
                const projectedProfit = projectedSales - (targetCv * cogs) - requiredBudget;
                const resultsData = [
                    { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
                    { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
                    { label: 'äºˆæ¸¬å£²ä¸Š', value: formatCurrency(projectedSales), color: 'text-indigo-600', metric: 'projected-sales' },
                    { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
                ];
                analysisHtml = `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 rounded-r-lg text-sm col-span-2" role="alert">
                                      <p class="font-bold">è¨ˆç®—ã®å‰æ</p>
                                      <p>ã“ã®è¨ˆç®—ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬ï¼ˆæ¨å®šCPA: ${formatCurrency(estimatedCpa)}ï¼‰ã‚’åŸºã«ã€ç›®æ¨™CVæ•° ${formatNumber(targetCv)}ä»¶ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªåºƒå‘Šäºˆç®—ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
                                    </div>`;
                renderResults(resultsData, analysisHtml);
                renderScenarioSection(targetCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
            } else { // cpa
                const targetCpa = parseFloat(document.getElementById('d-targetCpa').value) || 0;
                const targetProfit = parseFloat(document.getElementById('d-targetProfit').value) || 0;
                const profitPerCv = avgCustomerValue - cogs - targetCpa;
                const requiredCv = (profitPerCv > 0 && targetProfit > 0) ? Math.ceil(targetProfit / profitPerCv) : 0;
                const requiredBudget = requiredCv * targetCpa;
                const projectedSales = requiredCv * avgCustomerValue;
                const resultsData = [
                    { label: '1CVã‚ãŸã‚Šã®åˆ©ç›Š', value: formatCurrency(profitPerCv), color: 'text-indigo-600' },
                    { label: 'å¿…è¦CVæ•°', value: `${formatNumber(requiredCv)}ä»¶`, color: 'text-blue-600', metric: 'required-cv' },
                    { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
                    { label: 'äºˆæ¸¬å£²ä¸Š', value: formatCurrency(projectedSales), color: 'text-purple-600', metric: 'projected-sales' },
                ];
                 analysisHtml = `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 rounded-r-lg text-sm col-span-2" role="alert">
                                      <p class="font-bold">è¨ˆç®—ã®å‰æ</p>
                                      <p>ã“ã®è¨ˆç®—ã¯ã€è¨­å®šã—ãŸç›®æ¨™CPAï¼ˆ${formatCurrency(targetCpa)}ï¼‰ã§ç›®æ¨™åˆ©ç›Šï¼ˆ${formatCurrency(targetProfit)}ï¼‰ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªCVæ•°ã¨åºƒå‘Šäºˆç®—ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
                                    </div>`;
                renderResults(resultsData, analysisHtml);
                renderScenarioSection(requiredCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
            }
        }
        function renderScenarioSection(baseCv, cvr, cpc, title, formatter, unit = '', budget = null) {
            let valPessimistic, valRealistic, valOptimistic;
            if (currentMode === 'C') {
                const availableBudget = parseFloat(document.getElementById('c-availableBudget').value) || 0;
                const pessimisticCvr = cvr > 0 ? cvr * 0.5 : 0;
                const optimisticCvr = cvr * 1.5;
                const getProjectedCv = (targetCvr) => (targetCvr > 0 && cpc > 0 && availableBudget > 0) ? availableBudget / (cpc / (targetCvr / 100)) : 0;
                valPessimistic = getProjectedCv(pessimisticCvr);
                valRealistic = getProjectedCv(cvr);
                valOptimistic = getProjectedCv(optimisticCvr);
                resultsScenario.innerHTML = `
                    <h4 class="text-md font-semibold text-center text-teal-800 mb-2">ã‚·ãƒŠãƒªã‚ªåˆ¥ ${title}</h4>
                    <div class="space-y-3">
                        <div class="bg-red-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-red-800">æ‚²è¦³çš„ (CVR: ${pessimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-red-800">${formatter(valPessimistic)}${unit}</span></div></div>
                        <div class="bg-blue-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-blue-800">ç¾å®Ÿçš„ (CVR: ${cvr.toFixed(1)}%)</span><span class="font-bold text-lg text-blue-800">${formatter(valRealistic)}${unit}</span></div></div>
                        <div class="bg-green-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-green-800">æ¥½è¦³çš„ (CVR: ${optimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-green-800">${formatter(valOptimistic)}${unit}</span></div></div>
                    </div>`;
            } else {
                const requiredCv = baseCv;
                const pessimisticCvr = cvr > 0 ? cvr * 0.5 : 0;
                const optimisticCvr = cvr * 1.5;
                const calculateBudgetForScenario = (targetCvr) => {
                    if (targetCvr <= 0 || !isFinite(targetCvr) || cpc <= 0 || requiredCv <= 0) return 0;
                    const clicksNeeded = requiredCv / (targetCvr / 100);
                    return clicksNeeded * cpc;
                };
                valPessimistic = calculateBudgetForScenario(pessimisticCvr);
                valRealistic = calculateBudgetForScenario(cvr);
                valOptimistic = calculateBudgetForScenario(optimisticCvr);
                 resultsScenario.innerHTML = `
                    <h4 class="text-md font-semibold text-center text-teal-800 mb-2">ã‚·ãƒŠãƒªã‚ªåˆ¥ ${title}</h4>
                    <div class="space-y-3">
                        <div class="bg-red-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-red-800">æ‚²è¦³çš„ (CVR: ${pessimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-red-800">${formatter(valPessimistic)}${unit}</span></div></div>
                        <div class="bg-blue-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-blue-800">ç¾å®Ÿçš„ (CVR: ${cvr.toFixed(1)}%)</span><span class="font-bold text-lg text-blue-800">${formatter(valRealistic)}${unit}</span></div></div>
                        <div class="bg-green-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-green-800">æ¥½è¦³çš„ (CVR: ${optimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-green-800">${formatter(valOptimistic)}${unit}</span></div></div>
                    </div>`;
            }
            updateChart(title, ['æ‚²è¦³çš„', 'ç¾å®Ÿçš„', 'æ¥½è¦³çš„'], [valPessimistic, valRealistic, valOptimistic], formatter, unit);
        }
        function updateChart(label, labels, data, formatter, unit = '') {
            if (!budgetChart) return;
            const allDataIsZero = data.every(item => item === 0);
            if (allDataIsZero) {
                budgetChart.options.scales.y.max = 1;
            } else {
                delete budgetChart.options.scales.y.max;
            }
            budgetChart.data.datasets[0].label = label;
            budgetChart.data.labels = labels;
            budgetChart.data.datasets[0].data = data;
            budgetChart.options.plugins.tooltip.callbacks.label = (context) => `${context.dataset.label}: ${formatter(context.raw)}${unit}`;
            budgetChart.options.scales.y.ticks.callback = (value) => formatter(value);
            budgetChart.update();
        }
        function initChart() {
            const ctx = document.getElementById('budgetChart').getContext('2d');
            budgetChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgba(239, 68, 68, 0.6)', 'rgba(59, 130, 246, 0.6)', 'rgba(34, 197, 94, 0.6)'], borderColor: ['rgba(239, 68, 68, 1)', 'rgba(59, 130, 246, 1)', 'rgba(34, 197, 94, 1)'], borderWidth: 1 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {} },
                        title: { display: true, text: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®å¯è¦–åŒ–', font: { size: 16 }, color: '#374151', padding: { bottom: 20 } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {}
                        }
                    }
                }
            });
        }
        function setMode(mode) {
            currentMode = mode;
            simModeButtons.forEach(btn => {
                btn.classList.toggle('sim-mode-btn-active', btn.dataset.mode === mode);
                btn.classList.toggle('sim-mode-btn-inactive', btn.dataset.mode !== mode);
            });
            document.getElementById('mode-A-inputs').classList.toggle('hidden', mode !== 'A');
            document.getElementById('mode-B-inputs').classList.toggle('hidden', mode !== 'B');
            document.getElementById('mode-C-inputs').classList.toggle('hidden', mode !== 'C');
            document.getElementById('mode-D-inputs').classList.toggle('hidden', mode !== 'D');
            calculateAll();
        }
        simModeButtons.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
        simulatorInputs.forEach(input => input.addEventListener('input', calculateAll));
        document.getElementById('a-profit-btn').addEventListener('click', () => {
            modeA_cpa_calc_method = 'profit';
            document.getElementById('a-profit-wrapper').classList.remove('hidden');
            document.getElementById('a-roas-wrapper').classList.add('hidden');
            document.getElementById('a-roi-wrapper').classList.add('hidden');
            document.getElementById('a-profit-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
            document.getElementById('a-roas-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            document.getElementById('a-roi-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            calculateAll();
        });
        document.getElementById('a-roas-btn').addEventListener('click', () => {
            modeA_cpa_calc_method = 'roas';
            document.getElementById('a-profit-wrapper').classList.add('hidden');
            document.getElementById('a-roas-wrapper').classList.remove('hidden');
            document.getElementById('a-roi-wrapper').classList.add('hidden');
            document.getElementById('a-roas-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
            document.getElementById('a-profit-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            document.getElementById('a-roi-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            calculateAll();
        });
        document.getElementById('a-roi-btn').addEventListener('click', () => {
            modeA_cpa_calc_method = 'roi';
            document.getElementById('a-profit-wrapper').classList.add('hidden');
            document.getElementById('a-roas-wrapper').classList.add('hidden');
            document.getElementById('a-roi-wrapper').classList.remove('hidden');
            document.getElementById('a-roi-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
            document.getElementById('a-profit-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            document.getElementById('a-roas-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            calculateAll();
        });
        document.getElementById('d-cv-btn').addEventListener('click', () => {
            modeD_kpi_choice = 'cv';
            document.getElementById('d-cv-wrapper').classList.remove('hidden');
            document.getElementById('d-cpa-wrapper').classList.add('hidden');
            document.getElementById('d-cv-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
            document.getElementById('d-cpa-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            calculateAll();
        });
        document.getElementById('d-cpa-btn').addEventListener('click', () => {
            modeD_kpi_choice = 'cpa';
            document.getElementById('d-cv-wrapper').classList.add('hidden');
            document.getElementById('d-cpa-wrapper').classList.remove('hidden');
            document.getElementById('d-cpa-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
            document.getElementById('d-cv-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
            calculateAll();
        });
        ['a', 'b', 'c', 'd'].forEach(prefix => {
            const costTypeSelect = document.getElementById(`${prefix}-cost-type`);
            if (costTypeSelect) {
                costTypeSelect.addEventListener('change', (e) => {
                    document.getElementById(`${prefix}-cogs-wrapper`).classList.toggle('hidden', e.target.value !== 'cogs');
                    document.getElementById(`${prefix}-margin-wrapper`).classList.toggle('hidden', e.target.value !== 'margin');
                    calculateAll();
                });
            }
        });
        function showSection(sectionId) {
            contentSections.forEach(section => section.classList.toggle('hidden', section.id !== sectionId));
            navButtons.forEach(button => {
                const isActive = button.dataset.section === sectionId;
                button.classList.toggle('nav-active', isActive);
                button.classList.toggle('nav-inactive', !isActive);
            });
        }
        navButtons.forEach(button => button.addEventListener('click', () => showSection(button.dataset.section)));
        function loadCaseStudy(caseId) {
            const cs = data.caseStudies.find(c => c.id === caseId);
            if (cs) {
                const avgCustomerValue = cs.avgCustomerValue || 0;
                const cogs = cs.cogs || 0;
                const profitPerCv = cs.profitPerCv || 0;
                const limitCpa = avgCustomerValue - cogs;
                const targetCpaFromProfit = limitCpa - profitPerCv;
                const targetRoas = targetCpaFromProfit > 0 ? (avgCustomerValue / targetCpaFromProfit) * 100 : 0;
                const targetRoi = targetCpaFromProfit > 0 ? ((limitCpa - targetCpaFromProfit) / targetCpaFromProfit) * 100 : 0;
                document.getElementById('a-targetProfit').value = cs.targetProfit || '';
                document.getElementById('a-avgCustomerValue').value = avgCustomerValue;
                document.getElementById('a-cost-type').value = 'cogs';
                document.getElementById('a-cogs').value = cogs;
                document.getElementById('a-cogs-wrapper').classList.remove('hidden');
                document.getElementById('a-margin-wrapper').classList.add('hidden');
                document.getElementById('a-profitPerCv').value = profitPerCv;
                document.getElementById('a-targetRoas').value = targetRoas.toFixed(1);
                document.getElementById('a-targetRoi').value = targetRoi.toFixed(1);
                document.getElementById('a-profit-btn').click();
                document.getElementById('common-cvr').value = cs.cvr || '';
                document.getElementById('common-cpc').value = cs.cpc || '';
                productDescriptionInput.value = cs.description || '';
                const requiredCvForB = (profitPerCv > 0 && cs.targetProfit > 0) ? Math.ceil(cs.targetProfit / profitPerCv) : 0;
                const targetSales = requiredCvForB * avgCustomerValue;
                document.getElementById('b-targetSales').value = Math.round(targetSales);
                document.getElementById('b-avgCustomerValue').value = avgCustomerValue;
                document.getElementById('b-cost-type').value = 'cogs';
                document.getElementById('b-cogs').value = cogs;
                document.getElementById('b-cogs-wrapper').classList.remove('hidden');
                document.getElementById('b-margin-wrapper').classList.add('hidden');
                const estimatedCpaForC = cs.cvr > 0 ? cs.cpc / (cs.cvr / 100) : 0;
                const requiredBudgetForC = requiredCvForB * estimatedCpaForC;
                document.getElementById('c-availableBudget').value = Math.round(requiredBudgetForC);
                document.getElementById('c-avgCustomerValue').value = avgCustomerValue;
                document.getElementById('c-cost-type').value = 'cogs';
                document.getElementById('c-cogs').value = cogs;
                document.getElementById('c-cogs-wrapper').classList.remove('hidden');
                document.getElementById('c-margin-wrapper').classList.add('hidden');
                document.getElementById('d-avgCustomerValue').value = avgCustomerValue;
                document.getElementById('d-cost-type').value = 'cogs';
                document.getElementById('d-cogs').value = cogs;
                document.getElementById('d-cogs-wrapper').classList.remove('hidden');
                document.getElementById('d-margin-wrapper').classList.add('hidden');
                document.getElementById('d-targetCv').value = requiredCvForB;
                document.getElementById('d-targetCpa').value = Math.round(targetCpaFromProfit);
                document.getElementById('d-targetProfit').value = cs.targetProfit || '';
                calculateAll();
                showSection('simulator');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        function populateCaseStudies() {
            const container = document.getElementById('caseStudiesContainer');
            if(!container) return;
            container.innerHTML = data.caseStudies.map(cs => `<div class="case-study-card bg-white border border-gray-200 rounded-lg p-6 cursor-pointer" data-case-id="${cs.id}"><h3 class="text-lg font-bold text-teal-700">${cs.title}</h3><p class="text-gray-500">${cs.subtitle}</p><button class="mt-4 w-full bg-teal-600 text-white py-2 rounded-md hover:bg-teal-700 transition-colors">ã“ã®äº‹ä¾‹ã‚’èª­ã¿è¾¼ã‚€</button></div>`).join('');
            document.querySelectorAll('.case-study-card').forEach(card => card.addEventListener('click', () => loadCaseStudy(card.dataset.caseId)));
        }
        function populateBenchmarks() {
            const tabsContainer = document.getElementById('benchmarkTabs');
            const contentContainer = document.getElementById('benchmarkContent');
            if(!tabsContainer || !contentContainer) return;
            tabsContainer.innerHTML = Object.keys(data.benchmarks).map((key, index) => `<button data-benchmark-key="${key}" class="benchmark-tab py-3 px-1 border-b-2 text-sm font-medium ${index === 0 ? 'tab-active' : 'tab-inactive'}">${data.benchmarks[key].name}</button>`).join('');
            function showBenchmarkContent(key) {
                const benchmark = data.benchmarks[key];
                contentContainer.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>${benchmark.headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${benchmark.rows.map(row => `<tr>${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            }
            document.querySelectorAll('.benchmark-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.benchmark-tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
                    e.target.classList.replace('tab-inactive', 'tab-active');
                    showBenchmarkContent(e.target.dataset.benchmarkKey);
                });
            });
            showBenchmarkContent(Object.keys(data.benchmarks)[0]);
        }
        function populateOptimizationGuide() {
            const container = document.getElementById('accordionContainer');
            if(!container) return;
            container.innerHTML = data.optimization.map((item) => `<div class="border border-gray-200 rounded-lg"><button class="accordion-toggle w-full flex justify-between items-center p-4 text-left font-semibold text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none"><span>${item.title}</span><span class="transform transition-transform duration-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></span></button><div class="accordion-content"><div class="p-4 text-gray-600 bg-white">${item.content}</div></div></div>`).join('');
            document.querySelectorAll('.accordion-toggle').forEach(button => button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('svg').parentElement;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                    document.querySelectorAll('.accordion-toggle span.transform').forEach(i => i.style.transform = 'rotate(0deg)');
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.style.transform = 'rotate(180deg)';
                }
            }));
        }
        function populateKnowledge() {
            const container = document.getElementById('knowledge-container');
            if (!container) return;
            const knowledgeData = [
                { category: 'åŸºæœ¬æŒ‡æ¨™', color: 'teal', items: [
                    { term: 'IMP (Impression)', desc: 'åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚ŒãŸå›æ•°ã€‚ã™ã¹ã¦ã®åºƒå‘Šæ´»å‹•ã®åŸºç‚¹ã¨ãªã‚Šã¾ã™ã€‚' },
                    { term: 'CTR (ã‚¯ãƒªãƒƒã‚¯ç‡)', desc: 'åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚ŒãŸã†ã¡ã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå‰²åˆã€‚åºƒå‘Šã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é­…åŠ›åº¦ã‚’ç¤ºã—ã¾ã™ã€‚', formula: 'CTR(%) = (ã‚¯ãƒªãƒƒã‚¯æ•° Ã· IMP) Ã— 100' },
                    { term: 'CV (ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³)', desc: 'åºƒå‘Šä¸»ã«ã¨ã£ã¦ä¾¡å€¤ã®ã‚ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šå•†å“è³¼å…¥ã€å•ã„åˆã‚ã›ï¼‰ã€‚' },
                    { term: 'CVR (ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡)', desc: 'åºƒå‘Šã‚¯ãƒªãƒƒã‚¯ã®ã†ã¡ã€CVã«è‡³ã£ãŸå‰²åˆã€‚LPã®æœ‰åŠ¹æ€§ã‚’ç¤ºã™é‡è¦æŒ‡æ¨™ã€‚', formula: 'CVR(%) = (CVæ•° Ã· ã‚¯ãƒªãƒƒã‚¯æ•°) Ã— 100' }
                ]},
                { category: 'ã‚³ã‚¹ãƒˆæŒ‡æ¨™', color: 'sky', items: [
                    { term: 'CPC (ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡)', desc: 'åºƒå‘ŠãŒ1å›ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹ãŸã³ã«ç™ºç”Ÿã™ã‚‹è²»ç”¨ã€‚', formula: 'CPC = åºƒå‘Šè²» Ã· ã‚¯ãƒªãƒƒã‚¯æ•°' },
                    { term: 'CPM (ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å˜ä¾¡)', desc: 'åºƒå‘ŠãŒ1000å›è¡¨ç¤ºã•ã‚Œã‚‹ãŸã³ã«ã‹ã‹ã‚‹è²»ç”¨ã€‚èªçŸ¥åº¦å‘ä¸Šã®æŒ‡æ¨™ã¨ã—ã¦ç”¨ã„ã‚‰ã‚Œã¾ã™ã€‚', formula: 'CPM = (åºƒå‘Šè²» Ã· IMP) Ã— 1000' },
                    { term: 'CPA (é¡§å®¢ç²å¾—å˜ä¾¡)', desc: '1ä»¶ã®CVã‚’ç²å¾—ã™ã‚‹ãŸã‚ã«ã‹ã‹ã£ãŸè²»ç”¨ã€‚è²»ç”¨å¯¾åŠ¹æœã®æœ€é‡è¦æŒ‡æ¨™ã®ä¸€ã¤ã€‚', formulas: ['CPA = åºƒå‘Šè²» Ã· CVæ•°', 'CPA = CPC Ã· CVR'] }
                ]},
                { category: 'åç›Šæ€§æŒ‡æ¨™', color: 'green', items: [
                    { term: 'ROAS (åºƒå‘Šè²»ç”¨å¯¾åŠ¹æœ)', desc: 'åºƒå‘Šè²»ã«å¯¾ã—ã¦ã©ã‚Œã ã‘ã®å£²ä¸ŠãŒç™ºç”Ÿã—ãŸã‹ã‚’ç¤ºã™æŒ‡æ¨™ã€‚ECã‚µã‚¤ãƒˆã§ç‰¹ã«é‡è¦è¦–ã•ã‚Œã¾ã™ã€‚', formula: 'ROAS(%) = (å£²ä¸Š Ã· åºƒå‘Šè²») Ã— 100' },
                    { term: 'ROI (æŠ•è³‡åˆ©ç›Šç‡)', desc: 'æŠ•ä¸‹ã—ãŸåºƒå‘Šè²»ã‹ã‚‰ã€ã©ã‚Œã ã‘ã®åˆ©ç›ŠãŒç”Ÿã¾ã‚ŒãŸã‹ã‚’ç¤ºã™æŒ‡æ¨™ã€‚ã‚ˆã‚Šäº‹æ¥­è²¢çŒ®åº¦ã‚’æ¸¬ã‚Œã¾ã™ã€‚', formula: 'ROI(%) = (åˆ©ç›Š Ã· åºƒå‘Šè²») Ã— 100' },
                    { term: 'é™ç•ŒCPA', desc: '1CVã‚ãŸã‚Šã«ã‹ã‘ã‚‰ã‚Œã‚‹åºƒå‘Šè²»ã®ä¸Šé™é¡ã€‚ã“ã‚Œã‚’è¶…ãˆã‚‹ã¨èµ¤å­—ã«ãªã‚‹æç›Šåˆ†å²ç‚¹ã€‚', formula: 'é™ç•ŒCPA = å¹³å‡é¡§å®¢å˜ä¾¡ âˆ’ åŸä¾¡' },
                    { term: 'ç›®æ¨™CPA', desc: 'ç›®æ¨™åˆ©ç›Šã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€1CVã‚ãŸã‚Šã«è¨±å®¹ã•ã‚Œã‚‹åºƒå‘Šè²»ã€‚', formula: 'ç›®æ¨™CPA = é™ç•ŒCPA âˆ’ ç¢ºä¿ã—ãŸã„åˆ©ç›Š' },
                    { term: 'LTV (é¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤)', desc: 'ä¸€äººã®é¡§å®¢ãŒå–å¼•æœŸé–“å…¨ä½“ã§ã‚‚ãŸã‚‰ã™ç·åˆ©ç›Šã€‚ãƒªãƒ”ãƒ¼ãƒˆå•†æã§é‡è¦ã€‚', formula: 'LTV = é¡§å®¢å˜ä¾¡ Ã— ç²—åˆ©ç‡ Ã— è³¼è²·é »åº¦ Ã— å¥‘ç´„æœŸé–“' }
                ]},
                { category: 'è¨ˆç”»ç«‹æ¡ˆæŒ‡æ¨™', color: 'purple', items: [
                    { term: 'å¿…è¦CVæ•°', desc: 'è¨­å®šã—ãŸç›®æ¨™åˆ©ç›Šã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªCVã®ä»¶æ•°ã€‚', formula: 'å¿…è¦CVæ•° = ç›®æ¨™åˆ©ç›Š Ã· 1CVã‚ãŸã‚Šã®åˆ©ç›Š' },
                    { term: 'å¿…è¦åºƒå‘Šäºˆç®—', desc: 'ç®—å‡ºã•ã‚ŒãŸæ•°å€¤ã‚’åŸºã«ã€æœ€çµ‚çš„ã«å¿…è¦ã¨ãªã‚‹åºƒå‘Šè²»ç”¨ã®ç·é¡ã€‚', formula: 'å¿…è¦åºƒå‘Šäºˆç®— = å¿…è¦CVæ•° Ã— ç›®æ¨™CPA' }
                ]}
            ];
            let html = '';
            knowledgeData.forEach(cat => {
                html += `
                    <div>
                        <h3 class="text-2xl font-semibold text-${cat.color}-700 border-b-2 border-${cat.color}-200 pb-2 mb-4">${cat.category}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${cat.items.map(item => `
                                <div class="knowledge-card bg-white p-5 rounded-lg shadow-md border-l-4 border-${cat.color}-500">
                                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">${item.term}</h3>
                                    <p class="text-gray-600 mt-2 text-sm">${item.desc}</p>
                                    ${item.formula ? `<div class="mt-4 space-y-2"><div class="formula">${item.formula}</div></div>` : ''}
                                    ${item.formulas ? `<div class="mt-4 space-y-2">${item.formulas.map(f => `<div class="formula">${f}</div>`).join('')}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function showLoading(title) { aiResultContainer.innerHTML = `<div class="bg-gray-50 p-6 rounded-lg text-center"><h3 class="text-lg font-semibold text-teal-800 mb-4">${title}</h3><div class="flex justify-center items-center"><div class="loader"></div><p class="ml-4 text-gray-600">AIãŒç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p></div></div>`; }
        function showError(message) { aiResultContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"><strong class="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</strong><span class="block sm:inline"> ${message}</span></div>`; }
        async function callAIApi(payload) {
            const response = await fetch('/.netlify/functions/callGemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API error (${response.status}): ${errorText}`);
            }
            return response.json();
        }
        
        async function handleAIGeneration(type) {
            console.log(`%cAIç”Ÿæˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚¿ã‚¤ãƒ—: ${type}`, 'color: green; font-weight: bold;');
            const productDescription = productDescriptionInput.value.trim();
            const adUrl = adUrlInput.value.trim();
            if (!productDescription && !adUrl) {
                console.log('%cãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: å•†å“èª¬æ˜ãƒ»URLãŒæœªå…¥åŠ›ã§ã™ã€‚', 'color: red;');
                showError("å®£ä¼ã—ãŸã„å•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã€ã¾ãŸã¯å‚è€ƒURLã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (type === 'copy') {
                await generateAdCopy(productDescription, adUrl);
            } else if (type === 'targeting') {
                await generateTargetingIdeas(productDescription, adUrl);
            } else if (type === 'keywords') {
                await generateKeywords(productDescription, adUrl);
            }
        }

        async function generateAdCopy(productDescription, adUrl) {
            showLoading("åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆä¸­...");
            let prompt = `ã‚ãªãŸã¯å„ªç§€ãªãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ‹…å½“è€…ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€Googleæ¤œç´¢åºƒå‘Šç”¨ã®åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’å³å¯†ã«6ãƒ‘ã‚¿ãƒ¼ãƒ³ææ¡ˆã—ã¦ãã ã•ã„ã€‚

# æŒ‡ç¤º
- å„åºƒå‘Šãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯ã€å¿…ãšã€Œè¦‹å‡ºã—(headlines)ã€(30æ–‡å­—ä»¥å†…ã§3ã¤)ã¨ã€Œèª¬æ˜æ–‡(descriptions)ã€(90æ–‡å­—ä»¥å†…ã§2ã¤)ã®ä¸¡æ–¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
- å‡ºåŠ›ã¯æŒ‡å®šã•ã‚ŒãŸJSONå½¢å¼ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„ã€‚

# æä¾›æƒ…å ±`;
            if (productDescription) { prompt += `\n## å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦\n${productDescription}`; }
            if (adUrl) { prompt += `\n## å‚è€ƒURL\n${adUrl}`; }
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }], 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            ads: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        headlines: { type: "ARRAY", items: { type: "STRING" } },
                                        descriptions: { type: "ARRAY", items: { type: "STRING" } }
                                    },
                                    required: ["headlines", "descriptions"]
                                }
                            }
                        },
                        required: ["ads"]
                    }
                } 
            };
            try {
                const result = await callAIApi(payload);
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const resultText = result.candidates[0].content.parts[0].text;
                    const parsedResult = JSON.parse(resultText);
                    displayAdCopy(parsedResult.ads);
                } else {
                    throw new Error("äºˆæœŸã›ã¬APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã™ã€‚");
                }
            } catch (e) { 
                showError(e.message); 
                console.error(e);
            }
        }
        async function generateTargetingIdeas(productDescription, adUrl) {
            showLoading("ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã‚’ç”Ÿæˆä¸­...");
            let prompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ã‚¹ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€ãƒ‡ã‚¸ã‚¿ãƒ«åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

# æŒ‡ç¤º
- ã‚ãªãŸã®ä»»å‹™ã¯ã€æœ€ã‚‚ã‚ã‚ŠããŸã‚Šãªææ¡ˆã‚’é¿ã‘ã€ã“ã®å•†å“/ã‚µãƒ¼ãƒ“ã‚¹ã«ç‰¹æœ‰ã®æ©Ÿä¼šã‚’æ‰ãˆã‚‹ã€æœ€ã‚‚æ´å¯Ÿã«æº€ã¡ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®çµ„ã¿åˆã‚ã›ã‚’2ã¤ææ¡ˆã™ã‚‹ã“ã¨ã§ã™ã€‚
- ææ¡ˆã¯å¿…ãšã€1ã¤ã¯ã€ŒåŸºè»¸ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€(Googleåºƒå‘Šã¾ãŸã¯Metaåºƒå‘Š)ã‹ã‚‰ã€ã‚‚ã†1ã¤ã¯ã€Œæ‹¡å¼µãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€(X, LINE, TikTok, Yahoo!åºƒå‘Š, SmartNewsåºƒå‘Š, Google Display & Video 360ãªã©)ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚
- å¿…ãšæŒ‡å®šã•ã‚ŒãŸJSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
- å„é …ç›®ã¯ã€ç°¡æ½”ã‹ã¤æˆ¦ç•¥çš„ãªè¦ç‚¹ã«çµã£ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
- ãƒšãƒ«ã‚½ãƒŠã¯2ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚

# æä¾›æƒ…å ±`;
            if (productDescription) { prompt += `\n## å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦\n${productDescription}`; }
            if (adUrl) { prompt += `\n## å‚è€ƒURL\n${adUrl}`; }
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            overall_strategy: { type: "STRING", description: "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å…¨ä½“ã®åŸºæœ¬æˆ¦ç•¥ã‚’1ã€œ2æ–‡ã§è¦ç´„" },
                            primary_persona: {
                                type: "OBJECT",
                                description: "æœ€ã‚‚å„ªå…ˆã™ã¹ããƒ¡ã‚¤ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ",
                                properties: {
                                    profile: { type: "STRING", description: "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåƒã‚’ä¸€è¨€ã§è¡¨ç¾" },
                                    lifestyle_context: { type: "STRING", description: "ãƒšãƒ«ã‚½ãƒŠã®å¹´é½¢ã‚„æ€§åˆ¥ã«ã‚‚è§¦ã‚Œã¤ã¤ã€ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã‚„ä¾¡å€¤è¦³ã‚’1æ–‡ã§è¡¨ç¾" },
                                    interests_and_needs: { type: "ARRAY", description: "å…·ä½“çš„ãªèˆˆå‘³ãƒ»é–¢å¿ƒãƒ»ãƒ‹ãƒ¼ã‚ºã‚’æ–‡ç« ã§å³å¯†ã«2ç‚¹è¨˜è¿°", items: { type: "STRING" } },
                                    info_sources: { type: "ARRAY", description: "ä¸»ãªæƒ…å ±æºã®å…·ä½“ä¾‹(2ã¤)", items: { type: "STRING" } }
                                },
                                 required: ["profile", "lifestyle_context", "interests_and_needs", "info_sources"]
                            },
                            secondary_persona: {
                                type: "OBJECT",
                                description: "æ¬¡ã«ç‹™ã†ã¹ãã‚µãƒ–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ",
                                properties: {
                                    profile: { type: "STRING", description: "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåƒã‚’ä¸€è¨€ã§è¡¨ç¾" },
                                    lifestyle_context: { type: "STRING", description: "ãƒšãƒ«ã‚½ãƒŠã®å¹´é½¢ã‚„æ€§åˆ¥ã«ã‚‚è§¦ã‚Œã¤ã¤ã€ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã‚„ä¾¡å€¤è¦³ã‚’1æ–‡ã§è¡¨ç¾" },
                                    interests_and_needs: { type: "ARRAY", description: "å…·ä½“çš„ãªèˆˆå‘³ãƒ»é–¢å¿ƒãƒ»ãƒ‹ãƒ¼ã‚ºã‚’æ–‡ç« ã§å³å¯†ã«2ç‚¹è¨˜è¿°", items: { type: "STRING" } },
                                    info_sources: { type: "ARRAY", description: "ä¸»ãªæƒ…å ±æºã®å…·ä½“ä¾‹(2ã¤)", items: { type: "STRING" } }
                                },
                                 required: ["profile", "lifestyle_context", "interests_and_needs", "info_sources"]
                            },
                            platform_strategy: {
                                type: "OBJECT",
                                description: "åŸºè»¸ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨æ‹¡å¼µãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®çµ„ã¿åˆã‚ã›",
                                properties: {
                                    mainstay_platform: {
                                        type: "OBJECT",
                                        description: "Googleåºƒå‘Šã¾ãŸã¯Metaåºƒå‘Šã‹ã‚‰é¸æŠ",
                                         properties: {
                                            platform_name: { type: "STRING" },
                                            strategic_reason: { type: "STRING" },
                                            approach_example: { type: "STRING" }
                                        },
                                        required: ["platform_name", "strategic_reason", "approach_example"]
                                    },
                                    alternative_platform: {
                                        type: "OBJECT",
                                        description: "Google/Metaä»¥å¤–ã®å¤šæ§˜ãªåºƒå‘Šåª’ä½“ã‹ã‚‰é¸æŠ",
                                         properties: {
                                            platform_name: { type: "STRING" },
                                            strategic_reason: { type: "STRING" },
                                            approach_example: { type: "STRING" }
                                        },
                                        required: ["platform_name", "strategic_reason", "approach_example"]
                                    }
                                },
                                required: ["mainstay_platform", "alternative_platform"]
                            }
                        },
                        required: ["overall_strategy", "primary_persona", "secondary_persona", "platform_strategy"]
                    }
                }
            };
            try {
                const result = await callAIApi(payload);
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const parsedResult = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayTargetingIdeas(parsedResult);
                } else {
                    throw new Error("äºˆæœŸã›ã¬APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã™ã€‚");
                }
            } catch (error) {
                showError(error.message);
                console.error(error);
            }
        }
        async function generateKeywords(productDescription, adUrl) {
            showLoading("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ·±æ˜ã‚Šä¸­...");
            let prompt = `ã‚ãªãŸã¯å„ªç§€ãªæ¤œç´¢åºƒå‘Šã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ·±ã„ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’çªãã‚ˆã†ãªã€è³ªã®é«˜ã„æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

# æŒ‡ç¤º
- ä»¥ä¸‹ã®2ã¤ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã—ã€ãã‚Œãã‚Œ10å€‹ãšã¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
  1. è©³ç´°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (10å€‹): 3èªä»¥ä¸Šã§æ§‹æˆã•ã‚Œã€å…·ä½“çš„ãªãƒ‹ãƒ¼ã‚ºã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‹™ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  2. ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (10å€‹): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‚©ã¿ã‚„é¡˜æœ›ã€åˆ©ç”¨ã‚·ãƒ¼ãƒ³ã«åŸºã¥ã„ãŸã€ã‚ˆã‚Šæ·±ã„ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’çªãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
- å‡ºåŠ›ã¯æŒ‡å®šã•ã‚ŒãŸJSONå½¢å¼ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„ã€‚

# æä¾›æƒ…å ±`;
            if (productDescription) { prompt += `\n## å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦\n${productDescription}`; }
            if (adUrl) { prompt += `\n## å‚è€ƒURL\n${adUrl}`; }
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }], 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            long_tail_keywords: { 
                                type: "ARRAY", 
                                description: "è©³ç´°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰10å€‹ã®ãƒªã‚¹ãƒˆ",
                                items: { type: "STRING" } 
                            },
                            insight_keywords: { 
                                type: "ARRAY", 
                                description: "ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰10å€‹ã®ãƒªã‚¹ãƒˆ",
                                items: { type: "STRING" } 
                            }
                        },
                        required: ["long_tail_keywords", "insight_keywords"]
                    }
                } 
            };
            try {
                const result = await callAIApi(payload);
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const resultText = result.candidates[0].content.parts[0].text;
                    const parsedResult = JSON.parse(resultText);
                    displayKeywords(parsedResult);
                } else {
                    throw new Error("äºˆæœŸã›ã¬APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã™ã€‚");
                }
            } catch (e) { 
                showError(e.message); 
                console.error(e);
            }
        }
        function displayAdCopy(ads) {
            if (!ads || ads.length === 0) { 
                showError("åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); 
                return; 
            }
            let html = '<div><h3 class="text-lg font-semibold text-teal-800 mb-4 text-center">AIãŒç”Ÿæˆã—ãŸåºƒå‘Šã‚³ãƒ”ãƒ¼æ¡ˆ</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            ads.forEach((ad, index) => {
                const headlinesHtml = (ad.headlines || []).map(h => `<li>${h}</li>`).join('');
                const descriptionsHtml = (ad.descriptions || []).map(d => `<li>${d}</li>`).join('');
                html += `<div class="bg-gray-50 border border-gray-200 rounded-lg p-4"><h4 class="font-bold mb-2 text-gray-700">ãƒ‘ã‚¿ãƒ¼ãƒ³ ${index + 1}</h4><div class="space-y-2"><div><p class="text-sm font-semibold text-teal-700">è¦‹å‡ºã—:</p><ul class="list-disc list-inside text-gray-600 text-sm">${headlinesHtml}</ul></div><div><p class="text-sm font-semibold text-teal-700">èª¬æ˜æ–‡:</p><ul class="list-disc list-inside text-gray-600 text-sm">${descriptionsHtml}</ul></div></div></div>`;
            });
            aiResultContainer.innerHTML = html + '</div></div>';
        }
        function displayKeywords(data) {
            if (!data) {
                showError("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }
            let html = '<div class="space-y-8">';
            const renderKeywords = (title, keywords) => {
                if (!keywords || keywords.length === 0) return '';
                return `<div class="flex-1 min-w-[280px]">
                            <h4 class="font-semibold text-gray-700 text-lg mb-3">${title}</h4>
                            <div class="flex flex-wrap gap-2">${keywords.map(kw => `<span class="bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full">${kw}</span>`).join('')}</div>
                        </div>`;
            };
            html += `<div class="pt-8">
                        <h3 class="text-xl font-bold text-teal-800 mb-6 text-center">AIã«ã‚ˆã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ·±æ˜ã‚Šææ¡ˆ</h3>
                        <div class="flex flex-col md:flex-row justify-center gap-8">
                            ${renderKeywords('è©³ç´°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (Long-tail)', data.long_tail_keywords)}
                            ${renderKeywords('ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (Insight)', data.insight_keywords)}
                        </div>
                     </div>`;
            aiResultContainer.innerHTML = html + '</div>';
        }
        function displayTargetingIdeas(data) {
            if (!data) {
                showError("ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }
            let html = '<div class="bg-white border border-gray-200 rounded-lg p-6 space-y-8">';
            html += '<h3 class="text-xl font-bold text-teal-800 text-center">AIã«ã‚ˆã‚‹ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆ</h3>';
            if (data.overall_strategy) {
                html += `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®åŸºæœ¬æ–¹é‡
                        </h4>
                        <p class="bg-teal-50 border-l-4 border-teal-500 text-teal-800 p-4 rounded-r-lg">${data.overall_strategy}</p>
                    </div>`;
            }
            const renderPersona = (persona, title) => {
                if (!persona) return '';
                let personaHtml = `<div class="border border-gray-200 rounded-lg p-4 space-y-4">
                                    <h5 class="font-bold text-md text-gray-700">${title}</h5>
                                    <p class="bg-gray-100 p-3 rounded-md font-semibold text-gray-800">ğŸ¯ ${persona.profile || ''}</p>
                                    <div>
                                        <h6 class="font-semibold text-sm text-gray-600">ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«èƒŒæ™¯</h6>
                                        <p class="text-sm text-gray-700 mt-1">${persona.lifestyle_context || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h6 class="font-semibold text-sm text-gray-600">å…·ä½“çš„ãªèˆˆå‘³ãƒ»é–¢å¿ƒãƒ»ãƒ‹ãƒ¼ã‚º</h6>
                                        <ul class="list-disc list-inside text-sm text-gray-700 mt-1 pl-2 space-y-1">${(persona.interests_and_needs || []).map(item => `<li>${item}</li>`).join('')}</ul>
                                    </div>
                                    <div>
                                        <h6 class="font-semibold text-sm text-gray-600">ä¸»ãªæƒ…å ±æº</h6>
                                        <div class="flex flex-wrap gap-2 mt-1">${(persona.info_sources || []).map(item => `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">${item}</span>`).join('')}</div>
                                    </div>
                                   </div>`;
                return personaHtml;
            };
            html += `<div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            æ¨å¥¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${renderPersona(data.primary_persona, 'No.1 ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ')}
                            ${renderPersona(data.secondary_persona, 'No.2 ã‚µãƒ–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ')}
                        </div>
                     </div>`;
        const renderPlatform = (platform) => {
            if (!platform) return '';
            return `<div class="bg-gray-50 p-4 rounded-lg border">
                        <h5 class="font-bold text-md text-teal-700">${platform.platform_name || ''}</h5>
                        <p class="text-sm text-gray-700 mt-2"><strong class="font-semibold">ç†ç”±:</strong> ${platform.strategic_reason || ''}</p>
                        <p class="text-sm text-gray-700 mt-1"><strong class="font-semibold">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¾‹:</strong> ${platform.approach_example || ''}</p>
                     </div>`;
        }
        if (data.platform_strategy) {
            html += `<div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                           æ¨å¥¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨æˆ¦ç•¥
                        </h4>
                        <div class="space-y-4">
                            ${renderPlatform(data.platform_strategy.mainstay_platform)}
                            ${renderPlatform(data.platform_strategy.alternative_platform)}
                        </div>
                    </div>`;
        }
        html += '</div>';
        aiResultContainer.innerHTML = html;
    }
    document.body.addEventListener('click', (e) => {
        const icon = e.target.closest('.info-icon');
        if (icon) {
            const metricKey = icon.dataset.metric;
            const data = tooltipData[metricKey];
            if (tooltip.classList.contains('visible') && tooltip.dataset.currentMetric === metricKey) {
                tooltip.classList.remove('visible');
                return;
            }
            document.getElementById('tooltip-title').textContent = data.title;
            document.getElementById('tooltip-desc').innerHTML = data.desc;
            document.getElementById('tooltip-formula').innerHTML = data.formula;
            const iconRect = icon.getBoundingClientRect();
            tooltip.classList.add('visible');
            let top = iconRect.top + window.scrollY - tooltip.offsetHeight - 10;
            let left = iconRect.left + window.scrollX - (tooltip.offsetWidth / 2) + (iconRect.width / 2);
            if (top < window.scrollY) {
                top = iconRect.bottom + window.scrollY + 10;
            }
            if (left < 0) {
                left = 5;
            }
            if (left + tooltip.offsetWidth > window.innerWidth) {
                left = window.innerWidth - tooltip.offsetWidth - 5;
            }
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.dataset.currentMetric = metricKey;
        } else if (!e.target.closest('#tooltip')) {
             tooltip.classList.remove('visible');
        }
    });

    generateCopyBtn.addEventListener('click', () => handleAIGeneration('copy'));
    generateTargetingBtn.addEventListener('click', () => handleAIGeneration('targeting'));
    generateKeywordsBtn.addEventListener('click', () => handleAIGeneration('keywords'));

    initChart();
    setMode('A');
    document.getElementById('a-profit-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
    document.getElementById('d-cv-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
    populateCaseStudies();
    populateBenchmarks();
    populateOptimizationGuide();
    populateKnowledge();
}

// åˆæœŸèªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹
checkAuthStatus();

});
</script>

</body>
</html>